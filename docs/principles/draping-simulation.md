# 드레이핑 시뮬레이션 원리

> 이 문서는 이룸 PC-1+ 드레이핑 시뮬레이션의 기반이 되는 광학 원리를 설명한다.
>
> **소스 리서치**: PC-1-R1, CIE-3-R1
> **관련 원리**: [color-science.md](./color-science.md) Section 1 (Lab 색공간)

---

## 0. 궁극의 형태 (P1)

### 이상적 최종 상태

```
"완벽한 드레이핑 시뮬레이션 시스템"

- 실시간 3D 얼굴 메쉬 기반 천 시뮬레이션 (Physics-based cloth rendering)
- 실제 조명 환경 반영 (IBL: Image-Based Lighting)
- 사용자 피부에 반사되는 색상 영향을 Lab 색공간에서 정밀 측정
- 제품(의류, 액세서리) 실제 색상 데이터와 1:1 매칭
- AR 기반 실시간 비디오 드레이핑
```

### 물리적 한계

| 항목               | 한계                                                 |
| ------------------ | ---------------------------------------------------- |
| Canvas 2D          | 3D 광학 시뮬레이션 불가, 2D 블렌딩만 가능            |
| 카메라 색역        | sRGB 한계, 실제 천 색상과 차이 존재                  |
| 얼굴 마스크 정밀도 | MediaPipe 468 랜드마크 기반, 머리카락/귀 영역 부정확 |
| 반사광 모델        | 단순 HSL 조정, 실제 반사광 물리학(BRDF) 미적용       |

### 100점 기준

- 드레이프 색상이 피부 영역 균일도에 미치는 영향 정확 측정
- 웜/쿨톤 반응 차이가 전문 컬러리스트 판정과 90% 이상 일치
- 사용자가 드레이핑 결과를 직관적으로 이해 가능
- 128색 분석이 10초 이내 완료 (중급 기기 기준)

### 현재 목표: 75%

- Canvas 2D 기반 색상 오버레이 + 균일도 측정 완성
- 상단 그라데이션 페이드 + 주름 노이즈로 자연스러운 표현
- MediaPipe 얼굴 마스크 기반 피부 영역 분리
- 금속(골드/실버) 반사광 시뮬레이션

### 의도적 제외

| 제외 항목          | 이유                                     | 재검토 시점         |
| ------------------ | ---------------------------------------- | ------------------- |
| WebGL 3D 렌더링    | Canvas 2D 대비 복잡도 5배, MVP 범위 초과 | Phase 3             |
| BRDF 반사 모델     | 계산 비용 대비 시각적 차이 미미          | 고급 사용자 요구 시 |
| 실시간 비디오      | WebRTC + 프레임 처리 지연                | AR 기술 성숙 시     |
| 천 물리 시뮬레이션 | 모바일 기기 성능 한계                    | Phase 3             |

---

## 1. 드레이핑 색상 반사 광학 원리

### 1.1 색상 반사의 기본 원리

드레이핑(Draping)은 천의 색상이 피부에 반사되어 피부톤을 변화시키는 현상을 관찰하는 기법이다.

```
물리적 과정:
1. 광원 → 천에 닿음
2. 천이 특정 파장을 흡수, 나머지를 반사
3. 반사된 색광이 피부에 도달
4. 피부의 멜라닌/헤모글로빈이 일부 파장을 흡수
5. 최종 반사광 = 피부 고유색 + 천 반사색의 혼합
```

### 1.2 웜톤/쿨톤 반응 차이

| 피부톤 | 웜색 드레이프 반응       | 쿨색 드레이프 반응       |
| ------ | ------------------------ | ------------------------ |
| 웜톤   | 피부 밝아짐, 균일도 향상 | 피부 칙칙해짐, 불균일    |
| 쿨톤   | 피부 노란기 강조, 불균일 | 피부 맑아짐, 균일도 향상 |

이 반응 차이를 **균일도(Uniformity)** 수치로 정량화한다.

### 1.3 구현에서의 색상 블렌딩

실제 광학적 반사 대신, 색상 블렌딩으로 근사한다:

```
최종 픽셀 = 원본 픽셀 × (1 - α) + 드레이프 색상 × α

여기서:
- α = 블렌딩 비율 (0.85 기본값)
- 상단 경계에서 α = 0.2 → 0.85 그라데이션 전환
- 얼굴 마스크 영역(faceMask=255)은 블렌딩 제외
```

---

## 2. 균일도 측정 (Uniformity Measurement)

### 2.1 기본 원리

드레이프 색상이 피부에 잘 어울리면 피부톤이 균일해지고, 어울리지 않으면 불균일해진다.

이를 **휘도(Luminance)의 표준편차**로 측정한다.

### 2.2 수학적 기반

```
1. 휘도 계산 (ITU-R BT.601):
   Y = 0.299R + 0.587G + 0.114B

2. 균일도 = σ(Y_face) (피부 영역 휘도의 표준편차)

   σ = √(Σ(Yi - Ȳ)² / N)

   여기서:
   - Yi = i번째 피부 픽셀의 휘도
   - Ȳ = 피부 영역 평균 휘도
   - N = 피부 픽셀 수

3. 점수 정규화:
   점수 = min(100, σ × 2)

   - σ = 0 → 점수 0 (완벽 균일 = 최고 어울림)
   - σ = 50 → 점수 100 (극심한 불균일 = 최저 어울림)
```

### 2.3 측정 과정

```
원본 이미지
    ↓
드레이프 색상 적용 (얼굴 마스크 외부)
    ↓
금속 반사광 적용 (얼굴 마스크 내부)
    ↓
피부 영역(마스크=255) 휘도 추출
    ↓
표준편차 계산
    ↓
균일도 점수 (0~100, 낮을수록 어울림)
```

### 2.4 한계와 보정

| 한계        | 영향                            | 현재 대응                   |
| ----------- | ------------------------------- | --------------------------- |
| 조명 불균일 | 한쪽이 밝으면 균일도 왜곡       | 비네팅 효과로 가장자리 보정 |
| 메이크업    | 파운데이션이 균일도 인위적 향상 | 미보정 (사용자 안내)        |
| 피부 결함   | 여드름 등이 균일도 저하         | 미보정 (있는 그대로 측정)   |

---

## 3. 얼굴 마스크 세그멘테이션

### 3.1 MediaPipe Face Mesh

```
468개 3D 랜드마크 → 얼굴 윤곽 폴리곤 생성 → Scanline Fill → 마스크

마스크 구조:
- Uint8Array(width × height)
- 255 = 피부 영역 (드레이프 미적용, 균일도 측정 대상)
- 0 = 비피부 영역 (드레이프 적용 대상)
```

### 3.2 영역 분리

| 영역      | 인덱스            | 마스크 값 | 처리          |
| --------- | ----------------- | --------- | ------------- |
| 얼굴 윤곽 | FACE_OVAL_INDICES | 255       | 균일도 측정   |
| 왼쪽 눈   | LEFT_EYE_INDICES  | 0 (제외)  | 피부 아님     |
| 오른쪽 눈 | RIGHT_EYE_INDICES | 0 (제외)  | 피부 아님     |
| 입술      | LIPS_INDICES      | 0 (제외)  | 피부 아님     |
| 나머지    | -                 | 0         | 드레이프 적용 |

### 3.3 Scanline Fill Algorithm

폴리곤 내부를 채우는 알고리즘:

```
for each scanline y:
  1. 모든 폴리곤 에지와 y의 교점 계산
  2. 교점을 x좌표 기준 정렬
  3. 짝수번째↔홀수번째 교점 사이를 채움
```

이 알고리즘은 O(N×H) 복잡도 (N=에지 수, H=높이 범위)로 효율적이다.

---

## 4. 드레이프 적용 세부 기법

### 4.1 드레이프 영역

```
이미지 상단 65%: 원본 유지 (얼굴/상체)
이미지 하단 35%: 드레이프 색상 적용 (목/어깨/가슴)

경계 처리:
- 65% ~ 73% 구간: 페이드 영역 (α = 0.2 → 0.85)
- 73% ~ 100% 구간: 완전 적용 (α = 0.85)
```

### 4.2 자연스러움 기법

#### 상단 그라데이션 페이드

```
α(y) = 0.2 + (localY / fadeZone) × 0.65

- localY = 0 (경계 시작): α = 0.2 (거의 투명)
- localY = fadeZone (경계 끝): α = 0.85 (거의 불투명)
```

#### 노이즈 기반 주름 효과

```
noise(x, y) = fract(sin(x × 12.9898 + y × 78.233) × 43758.5453) × 0.12 - 0.06

- 범위: -0.06 ~ +0.06 (±6% 밝기 변화)
- 의사 난수: 좌표 기반 결정적 함수 (매번 동일한 패턴)
- 효과: 실제 천의 접힘/주름 느낌
```

### 4.3 금속 반사광

피부 영역에 골드/실버 반사광을 적용하여 액세서리 효과를 시뮬레이션한다.

```
골드: brightness +5, saturation +5 (따뜻한 광택)
실버: brightness +10, saturation -5 (차가운 광택)

처리: HSL 색공간에서 밝기(L)와 채도(S) 조정
```

---

## 5. 성능과 메모리 제한

### 5.1 Canvas 크기 제한

```
MAX_CANVAS_SIZE = 1024px (비율 유지)

이유:
- Canvas 2D pixel manipulation은 O(W×H) 복잡도
- 1024×1024 = ~4MB 이미지 데이터
- 2048×2048 = ~16MB → 모바일에서 OOM 위험
```

### 5.2 배치 처리

```
전체 팔레트 분석 시:
- 16/64/128색을 순차 분석
- 10색마다 setTimeout(0)으로 UI 스레드 양보
- 각 색상별 임시 Canvas 생성 → 분석 → 해제
```

### 5.3 메모리 예산

```
얼굴 마스크: width × height bytes (최대 ~1MB at 1024×1024)
이미지 데이터: width × height × 4 bytes (최대 ~4MB)
임시 Canvas: 1개씩 순차 사용 후 해제

총 피크 메모리: ~10MB (안전 범위)
```

---

## 6. 검증 방법

### 6.1 균일도 측정 정확성

```
테스트 방법:
1. 동일 피부톤 이미지에 웜/쿨 계열 색상 각 10개 적용
2. 웜톤 피부 + 웜색 → 균일도 < 웜톤 피부 + 쿨색 확인
3. 쿨톤 피부 + 쿨색 → 균일도 < 쿨톤 피부 + 웜색 확인
```

### 6.2 시각적 품질

```
체크리스트:
□ 드레이프 경계가 자연스럽게 페이드
□ 주름 효과가 과하지 않게 적용
□ 얼굴 영역에 드레이프 색 침범 없음
□ 금속 반사광이 피부에만 적용
□ 비네팅이 가장자리를 부드럽게 어둡게
```

---

## 7. 참고 자료

- [color-science.md](./color-science.md) - Lab 색공간, CIEDE2000
- [image-processing.md](./image-processing.md) - Canvas 처리 원리
- MediaPipe Face Mesh: https://google.github.io/mediapipe/solutions/face_mesh.html
- ITU-R BT.601: 휘도 가중치 표준
- Scanline Fill Algorithm: Computer Graphics 기본 래스터화 기법

---

**Version**: 1.0 | **Created**: 2026-02-06
**적용 모듈**: PC-1+ 드레이핑 시뮬레이션
**관련 코드**: `lib/analysis/drape-reflectance.ts`, `lib/analysis/face-landmark.ts`
