# 데이터 플랫폼 원리

> **작성일**: 2026-02-01
> **P7 단계**: 원리 (Principles)
> **의존성**: L-R1, L-R2

---

## 1. 핵심 원칙

### 1.1 데이터 자산의 본질

```
데이터 플랫폼의 가치 = f(수집 품질, 연계 정확도, 활용 효과)

여기서:
- 수집 품질: 이벤트의 완전성, 정확성, 적시성
- 연계 정확도: 이벤트-분석-제품 간 연결의 정확성
- 활용 효과: 데이터가 비즈니스 결정에 미치는 영향
```

### 1.2 이룸 데이터 플랫폼의 3대 원칙

| 원칙 | 설명 | 실천 |
|------|------|------|
| **Single Source of Truth** | 제품/사용자의 진실은 하나 | Product Master DB |
| **Event Immutability** | 이벤트는 수정 불가, 추가만 가능 | append-only log |
| **Attribution First** | 모든 이벤트는 출처를 기록 | source_analysis_id |

---

## 2. 이벤트 수집 원리

### 2.1 이벤트 분류 체계

```
┌─────────────────────────────────────────────────────────────┐
│                    이벤트 분류 피라미드                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│                    ┌───────────────┐                        │
│                    │   Conversion   │  구매, 전환           │
│                    │    Events      │  (High Value)         │
│                    └───────┬───────┘                        │
│                            │                                │
│                ┌───────────┴───────────┐                    │
│                │    Engagement Events   │  클릭, 저장        │
│                │                        │  (Medium Value)    │
│                └───────────┬───────────┘                    │
│                            │                                │
│        ┌───────────────────┴───────────────────┐           │
│        │           Interaction Events           │          │
│        │                                        │          │
│        │  페이지뷰, 스크롤, 체류시간 (Low Value)  │          │
│        └────────────────────────────────────────┘          │
│                                                             │
│  가치 = 희소성 × 의도 명확성                                 │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 이벤트 스키마 원칙

모든 이벤트는 다음 필드를 포함해야 한다:

```typescript
interface BaseEvent {
  // 필수: 식별
  event_id: string;          // UUID
  event_type: EventType;     // 이벤트 유형
  timestamp: string;         // ISO 8601

  // 필수: 주체
  user_id?: string;          // 로그인 사용자
  anonymous_id?: string;     // 비로그인 사용자

  // 필수: 맥락
  session_id: string;        // 세션 식별자
  page_url: string;          // 현재 페이지

  // 선택: 출처 귀속 (Attribution)
  source_analysis_id?: string;
  source_analysis_type?: AnalysisType;

  // 선택: 대상
  product_master_id?: string;
  match_score?: number;

  // 메타데이터
  properties: Record<string, unknown>;
}
```

### 2.3 배치 처리 원칙

```
최적의 배치 크기 = min(10개 이벤트, 5초 경과)

이유:
1. 네트워크 효율: 개별 요청 대비 오버헤드 감소
2. 데이터 손실 최소화: 5초 이상 대기 시 페이지 이탈로 손실 위험
3. 사용자 경험: 큐 처리가 UI 블로킹하지 않음
```

---

## 3. Attribution 모델 원리

### 3.1 Attribution의 목적

```
"왜 이 사용자가 이 제품을 클릭했는가?"

답변 가능해야 하는 질문:
1. 어떤 분석 결과가 이 추천을 유발했는가?
2. 매칭 점수는 얼마였는가?
3. 추천 목록에서 몇 번째였는가?
```

### 3.2 First-Touch Attribution

```
분석 완료 → 추천 노출 → 클릭 → 구매

Attribution은 "분석 완료" 시점에 고정된다.

이유:
1. 분석이 추천의 근거이므로 인과관계 명확
2. 추천 품질 개선의 피드백 루프 형성 가능
3. 브랜드에게 가치 증명 가능
```

### 3.3 Attribution 데이터 모델

```sql
-- 클릭 이벤트의 Attribution 필드
{
  "source_analysis_id": "uuid-of-skin-analysis",
  "source_analysis_type": "skin",
  "match_score": 87,
  "recommendation_position": 2,
  "recommendation_context": "main_result"
}

-- 이 데이터로 답변 가능한 질문:
-- Q: "피부 분석 결과가 구매로 얼마나 이어지는가?"
-- A: SELECT conversion_rate FROM ... WHERE source_analysis_type = 'skin'
```

---

## 4. 제품 데이터 통합 원리

### 4.1 Internal SKU의 필요성

```
문제:
┌──────────┐     ┌──────────┐     ┌──────────┐
│ 쿠팡     │     │ iHerb    │     │ 무신사    │
│ ID: A123 │     │ ID: X789 │     │ ID: M456 │
└────┬─────┘     └────┬─────┘     └────┬─────┘
     │                │                │
     └────────────────┼────────────────┘
                      │
                같은 제품인지 알 수 없음

해결:
┌──────────┐     ┌──────────┐     ┌──────────┐
│ 쿠팡     │     │ iHerb    │     │ 무신사    │
│ ID: A123 │     │ ID: X789 │     │ ID: M456 │
└────┬─────┘     └────┬─────┘     └────┬─────┘
     │                │                │
     └────────────────┼────────────────┘
                      ▼
              ┌──────────────┐
              │ Product      │
              │ Master       │
              │ SKU: YR-001  │
              └──────────────┘

→ 모든 분석이 하나의 제품 ID로 통합
```

### 4.2 SKU 생성 규칙

```
Internal SKU 형식: YR-{CATEGORY}-{SEQUENCE}

예시:
- YR-SKIN-00001: 스킨케어 제품 1번
- YR-SUPP-00123: 영양제 123번
- YR-FASH-00456: 패션 456번

규칙:
1. 순차적 할당 (중복 방지)
2. 카테고리 코드로 빠른 식별
3. 영구적 (한번 할당된 SKU는 재사용 안 함)
```

### 4.3 External ID 매핑 원칙

```typescript
// JSONB 기반 유연한 매핑
external_ids: {
  "coupang": "A123",
  "iherb": "X789",
  "musinsa": "M456",
  "olive_young": "OY789"
}

// 조회 패턴
// 쿠팡 ID로 내부 SKU 찾기
SELECT internal_sku
FROM product_master
WHERE external_ids @> '{"coupang": "A123"}'

// 새 파트너 추가 시 스키마 변경 불필요
```

---

## 5. 사용자 선호도 학습 원리

### 5.1 암시적 vs 명시적 피드백

```
┌─────────────────────────────────────────────────────────────┐
│                     피드백 유형 비교                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  명시적 피드백 (Explicit)                                    │
│  ├── 평점, 리뷰, 좋아요/싫어요                               │
│  ├── 장점: 의도 명확                                        │
│  └── 단점: 수집량 적음, 편향 가능                            │
│                                                             │
│  암시적 피드백 (Implicit)                                    │
│  ├── 클릭, 체류시간, 스크롤 깊이, 구매                       │
│  ├── 장점: 수집량 많음, 자연스러움                           │
│  └── 단점: 해석 필요, 노이즈 포함                            │
│                                                             │
│  이룸 전략: 암시적 피드백 중심 + 분석 결과로 보완             │
│  → 분석 결과 = "과학적으로 검증된 명시적 피드백"              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 지수 이동 평균 (EMA) 기반 업데이트

```
선호도 업데이트 공식:

P(t) = α × S(t) + (1 - α) × P(t-1)

여기서:
- P(t): 시점 t에서의 선호도 점수
- S(t): 시점 t에서의 시그널 값
- α: 학습률 (이룸 기본값: 0.1)
- P(t-1): 이전 선호도 점수

α = 0.1의 의미:
- 최근 행동이 10% 반영
- 과거 이력이 90% 유지
- 급격한 변화 방지, 안정적 학습
```

### 5.3 시그널 가중치

```typescript
const SIGNAL_WEIGHTS: Record<EventType, number> = {
  page_view: 0.5,      // 단순 조회
  click: 1.0,          // 클릭
  add_to_wishlist: 2.0, // 찜하기
  add_to_cart: 3.0,    // 장바구니
  purchase: 5.0,       // 구매
  repurchase: 10.0,    // 재구매
  review: 3.0,         // 리뷰 작성
};

// 적용 예시:
// 사용자가 "라운드랩" 브랜드 제품을 구매함
// 현재 brand_affinity["라운드랩"] = 0.5
// 새 시그널: 구매 (weight = 5.0)
// 정규화된 시그널: 5.0 / 10.0 = 0.5
// 새 친밀도: 0.1 × 0.5 + 0.9 × 0.5 = 0.5 (변화 없음 - 이미 높음)
```

### 5.4 신뢰도 (Confidence) 계산

```
신뢰도 = 1 - e^(-k × n)

여기서:
- n: 상호작용 횟수
- k: 학습 속도 상수 (이룸 기본값: 0.1)

해석:
- n = 0: 신뢰도 = 0 (데이터 없음)
- n = 10: 신뢰도 = 0.63
- n = 30: 신뢰도 = 0.95
- n = 50: 신뢰도 = 0.99

적용:
- 신뢰도 < 0.5: 탐색(exploration) 모드
- 신뢰도 ≥ 0.5: 활용(exploitation) 모드
```

---

## 6. 개인화 추천 원리

### 6.1 하이브리드 추천 전략

```
이룸 추천 = w₁ × 분석기반 + w₂ × 협업필터링 + w₃ × 탐색

여기서:
- 분석기반: 피부/퍼스널컬러/체형 분석 결과 매칭
- 협업필터링: 유사 사용자의 선호 제품
- 탐색: 새로운 제품/브랜드 노출

가중치 (신뢰도에 따라 조정):
- 신뢰도 < 0.3: w₁=0.7, w₂=0.1, w₃=0.2 (분석 의존)
- 신뢰도 0.3-0.7: w₁=0.5, w₂=0.3, w₃=0.2 (균형)
- 신뢰도 > 0.7: w₁=0.4, w₂=0.4, w₃=0.2 (행동 기반 강화)
```

### 6.2 분석 기반 매칭 공식

```
매칭 점수 = Σ(속성 점수 × 속성 가중치) / Σ(가중치)

현재 matching.ts의 가중치:
- skinType: 30점
- skinConcerns: 30점 (10점 × 3개 고민)
- personalColor: 20점
- priceRange: 10점
- ingredients: 10점
```

### 6.3 Exploration vs Exploitation

```
탐색-활용 트레이드오프:

┌─────────────────────────────────────────────────────────────┐
│                                                             │
│  탐색 (Exploration)                                          │
│  ├── 새로운 브랜드/제품 노출                                 │
│  ├── 필터 버블 방지                                          │
│  └── 장기적 데이터 수집                                      │
│                                                             │
│  활용 (Exploitation)                                         │
│  ├── 검증된 선호도 기반 추천                                 │
│  ├── 단기 전환율 최대화                                      │
│  └── 사용자 만족도 향상                                      │
│                                                             │
│  이룸 기본 비율: 80% 활용 + 20% 탐색                         │
│  (exploration_rate = 0.2)                                    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 7. 프라이버시 원칙

### 7.1 데이터 최소화

```
수집 원칙:
1. 목적에 필요한 최소한의 데이터만 수집
2. 익명화 가능한 데이터는 익명화
3. 보존 기간 명시 및 자동 삭제
```

### 7.2 집계 임계값

```
K-익명성 원칙:

브랜드 인사이트 제공 시:
- 그룹 크기 < 10: 표시 안 함
- 그룹 크기 10-50: 범위로 표시 ("10-20명")
- 그룹 크기 > 50: 정확한 수치 표시

이유:
- 작은 그룹에서 개인 식별 위험
- 통계적 유의성 확보
```

### 7.3 데이터 보존 정책

```
이벤트 라이프사이클:

Raw Events (30일)
    ↓ 집계
Aggregated Data (1년)
    ↓ 요약
Summary Statistics (영구)

개인 식별 가능 데이터:
- 30일 후 집계 테이블로 이동
- 원본에서 PII 제거
```

---

## 8. 검증 체크리스트

### 8.1 원리 준수 확인

```markdown
## 이벤트 수집 검증
- [ ] 모든 이벤트에 event_id, event_type, timestamp 포함
- [ ] 배치 처리 10개/5초 설정 확인
- [ ] Attribution 필드 (source_analysis_id 등) 포함

## 제품 데이터 검증
- [ ] Product Master에 internal_sku 존재
- [ ] external_ids JSONB 형식 올바름
- [ ] 분석 연계 속성 (skin_types 등) 정의됨

## 선호도 학습 검증
- [ ] EMA 업데이트 공식 적용
- [ ] 시그널 가중치 표 준수
- [ ] 신뢰도 계산 로직 포함

## 프라이버시 검증
- [ ] K-익명성 임계값 (k=10) 적용
- [ ] 30일 원본 이벤트 삭제 정책
- [ ] 옵트아웃 메커니즘 존재
```

---

## 9. 관련 문서

- [L-R1: 데이터 플랫폼 전략 리서치](../research/claude-ai-research/L-R1-data-platform-strategy.md)
- [L-R2: 국내 플랫폼 사례 분석](../research/claude-ai-research/L-R2-domestic-case-study.md)
- [현재 Analytics 구현](../../apps/web/lib/analytics/tracker.ts)
- [현재 Matching 구현](../../apps/web/lib/products/matching.ts)

---

**문서 상태**: 완료
**다음 단계**: L-A1 (ADR-061 초안)
**검증자**: -
