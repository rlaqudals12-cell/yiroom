# 이룸 사용자 플로우

> 사용자 행동 경우의 수 및 캡슐 대체 로직
>
> **핵심 원칙**: "모든 경우에 대안이 있다"

---

## 1. 플로우 설계 원칙

### 1.1 캡슐 접근법

```
문제: 사용자 행동은 예측 불가능
해결: 모든 상황에 대안을 준비

"Happy Path만 설계하지 않는다"
"Unhappy Path에도 좋은 경험을 제공한다"
```

### 1.2 경우의 수 분류

| 유형 | 설명 | 대응 |
|------|------|------|
| **Happy Path** | 정상 플로우 | 최적 경험 |
| **Edge Case** | 예외 상황 | 대체 플로우 |
| **Error Case** | 실패 상황 | 복구 플로우 |
| **Abort Case** | 중단 상황 | 재진입 플로우 |

---

## 2. 온보딩 플로우

### 2.1 Happy Path

```
[앱 시작] → [회원가입] → [기본 정보 입력] → [첫 분석] → [대시보드]
```

### 2.2 경우의 수 매트릭스

| 단계 | Edge Case | 대응 |
|------|-----------|------|
| **회원가입** | 만 14세 미만 | 가입 차단 + 안내 |
| | 이미 가입됨 | 로그인으로 이동 |
| | 소셜 로그인 실패 | 이메일 대체 |
| **기본 정보** | 중간 이탈 | 저장 후 재진입 |
| | 필수 항목 누락 | 항목별 안내 |
| **첫 분석** | 이미지 품질 불량 | 재촬영 안내 |
| | AI 분석 실패 | Mock 결과 + 재분석 제안 |
| | 시간 초과 | 타임아웃 + 재시도 |

### 2.3 온보딩 상태 다이어그램

```
[미가입] ──가입──► [가입완료]
    │                  │
    └──◄──가입중단──◄──┘
                       │
              [기본정보 입력] ──완료──► [첫분석대기]
                       │                    │
                       └──중단──► [재진입]   │
                                            │
                              [첫분석완료] ◄──┘
                                    │
                                    ▼
                              [활성사용자]
```

### 2.4 재진입 포인트

| 이탈 지점 | 저장 데이터 | 재진입 시 |
|----------|------------|----------|
| 회원가입 중 | 없음 | 처음부터 |
| 기본정보 중 | 입력된 필드 | 마지막 필드부터 |
| 첫분석 중 | 이미지 | 분석 재시도 |

---

## 3. 분석 플로우

### 3.1 이미지 촬영/업로드

#### 3.1.1 경우의 수

| 상황 | 원인 | 대응 |
|------|------|------|
| **촬영 성공** | - | 분석 진행 |
| **카메라 권한 거부** | 사용자 거부 | 갤러리 업로드 안내 |
| **저화질 이미지** | 조명, 흔들림 | 구체적 재촬영 안내 |
| **얼굴 미감지** | 각도, 가림 | 포즈 가이드 표시 |
| **다중 얼굴** | 여러 명 | 주 대상 선택 UI |
| **이미지 용량 초과** | 고해상도 | 자동 리사이즈 |

#### 3.1.2 이미지 품질 판정

```typescript
interface ImageQualityResult {
  isValid: boolean;
  issues: QualityIssue[];
  suggestions: string[];
}

type QualityIssue =
  | 'too_dark'       // "조명이 어두워요"
  | 'too_bright'     // "조명이 너무 밝아요"
  | 'blurry'         // "이미지가 흐릿해요"
  | 'no_face'        // "얼굴을 찾을 수 없어요"
  | 'face_too_small' // "얼굴이 너무 작아요"
  | 'face_angle';    // "정면을 바라봐 주세요"
```

### 3.2 AI 분석

#### 3.2.1 Fallback 체인

```
[AI 분석 요청]
      │
      ▼
[Gemini 호출] ──성공──► [결과 반환]
      │
      ▼ 실패/타임아웃
[재시도 (2회)] ──성공──► [결과 반환]
      │
      ▼ 실패
[캐시 확인] ──있음──► [캐시 결과 + "이전 결과" 표시]
      │
      ▼ 없음
[Mock 생성] ──► [예상 결과 + "예상 결과" 배지]
      │
      ▼
[재분석 제안 UI]
```

#### 3.2.2 결과 신뢰도 표시

| Source | 신뢰도 | UI 표시 |
|--------|--------|---------|
| `ai` (fresh) | 높음 | 없음 |
| `cache` | 중간 | "이전 분석 결과" |
| `mock` | 낮음 | "예상 결과" 배지 + 재분석 버튼 |

### 3.3 결과 확인

#### 3.3.1 결과 페이지 경우의 수

| 상황 | 대응 |
|------|------|
| 정상 결과 | 전체 정보 표시 |
| 부분 결과 | 가능한 정보만 + 누락 안내 |
| 낮은 신뢰도 | 재분석 권유 |
| 이전 결과와 다름 | 변화 비교 UI |

---

## 4. 추천 플로우

### 4.1 캡슐 추천 엔진

#### 4.1.1 패션 추천 경우의 수

```
[스타일 추천 요청]
      │
      ▼
[옷장 인벤토리 확인]
      │
      ├── 충분 ──► [보유 아이템 조합 추천]
      │                    │
      │                    ▼
      │              [1순위 + 대체 3개]
      │
      ├── 부족 ──► [부분 조합 + 구매 추천]
      │                    │
      │                    ▼
      │              [현재 가능 조합 + 추가 아이템]
      │
      └── 없음 ──► [일반 추천 + 시작 가이드]
```

#### 4.1.2 TPO별 추천

| TPO | 필수 아이템 | 대체 옵션 |
|-----|------------|----------|
| 출근 포멀 | 정장, 셔츠 | 블레이저 + 슬랙스 |
| 출근 캐주얼 | 블라우스, 슬랙스 | 니트 + 치마 |
| 데이트 | 원피스 | 블라우스 + 스커트 |
| 면접 | 정장 | 깔끔한 캐주얼 |

#### 4.1.3 아이템 없을 때 대체 로직

```typescript
interface CapsuleRecommendation {
  // 1순위: 보유 아이템 조합
  primary: {
    items: Item[];
    reason: string;
  };

  // 대체: 일부 아이템 대체
  alternatives: {
    items: Item[];
    substitutions: { original: Item; replacement: Item }[];
  }[];

  // 구매 추천: 없는 아이템
  suggestions: {
    item: Item;
    priority: 'essential' | 'recommended' | 'optional';
    reason: string;
  }[];
}
```

### 4.2 운동 추천 경우의 수

| 상황 | 원래 추천 | 대체 |
|------|----------|------|
| 헬스장 기구 사용 중 | 랫풀다운 | 덤벨 로우 |
| 기구 없음 | 레그프레스 | 스쿼트 |
| 시간 없음 | 1시간 루틴 | 20분 HIIT |
| 부상/제한 | 일반 스쿼트 | 월 스쿼트 |

### 4.3 영양 추천 경우의 수

| 상황 | 원래 추천 | 대체 |
|------|----------|------|
| 재료 없음 | 닭가슴살 | 두부, 달걀 |
| 알레르기 | 견과류 | 씨앗류 |
| 예산 제한 | 연어 | 고등어 |
| 채식 | 육류 | 콩류 |

---

## 5. 에러 처리 플로우

### 5.1 에러 유형별 대응

| 에러 유형 | 원인 | 사용자 메시지 | 액션 |
|----------|------|--------------|------|
| **네트워크** | 연결 끊김 | "인터넷 연결을 확인해주세요" | 재시도 버튼 |
| **인증** | 세션 만료 | "다시 로그인해주세요" | 로그인 이동 |
| **권한** | 접근 불가 | "접근 권한이 없습니다" | 뒤로가기 |
| **입력** | 검증 실패 | "[필드] 확인해주세요" | 필드 포커스 |
| **서버** | 500 에러 | "잠시 후 다시 시도해주세요" | 재시도 버튼 |
| **AI** | 분석 실패 | "분석에 실패했습니다" | 재분석 + Mock |

### 5.2 에러 복구 전략

```
[에러 발생]
      │
      ├── 자동 복구 가능 ──► [자동 재시도] ──► [성공] ──► [정상 플로우]
      │                            │
      │                            ▼ 실패
      │                       [Fallback 시도]
      │
      └── 사용자 액션 필요 ──► [에러 UI 표시]
                                   │
                                   ├── [재시도] ──► [재시도 플로우]
                                   ├── [다른 방법] ──► [대체 플로우]
                                   └── [취소] ──► [이전 화면]
```

---

## 6. 오프라인 지원

### 6.1 오프라인 가능 기능

| 기능 | 오프라인 지원 | 동작 |
|------|-------------|------|
| 이전 결과 조회 | ✅ | 캐시된 데이터 표시 |
| 인벤토리 조회 | ✅ | 로컬 저장소 |
| 새 분석 | ❌ | 오프라인 안내 |
| 제품 검색 | ⚠️ | 캐시된 제품만 |

### 6.2 오프라인 → 온라인 전환

```
[오프라인 상태]
      │
      ▼
[로컬 작업 수행] (인벤토리 추가 등)
      │
      ▼
[온라인 복구]
      │
      ▼
[동기화 큐 처리]
      │
      ├── 충돌 없음 ──► [자동 동기화]
      │
      └── 충돌 있음 ──► [충돌 해결 UI]
```

---

## 7. 상태 전환 다이어그램

### 7.1 사용자 상태

```
[방문자]
    │
    ▼
[미가입] ──가입──► [가입완료] ──온보딩──► [활성]
    │                                      │
    └──◄───────────탈퇴───────────────────◄┘
                                           │
                              [휴면] ◄──30일미접속
                                │
                                ├── 재접속 ──► [활성]
                                └── 1년 ──► [자동삭제]
```

### 7.2 분석 상태

```
[미분석]
    │
    ▼
[분석중] ──성공──► [분석완료]
    │                │
    │                └── 재분석 ──► [분석중]
    │
    └── 실패 ──► [분석실패]
                    │
                    ├── 재시도 ──► [분석중]
                    └── Mock ──► [예상결과]
```

---

## 8. 알림 플로우

### 8.1 알림 유형

| 유형 | 트리거 | 메시지 예시 |
|------|--------|------------|
| **분석 완료** | AI 분석 성공 | "분석이 완료되었어요!" |
| **추천 갱신** | 새 제품 매칭 | "새로운 추천 제품이 있어요" |
| **루틴 알림** | 예약 시간 | "오늘의 운동 시간이에요" |
| **휴면 경고** | 7일 미접속 | "다시 만나고 싶어요" |

### 8.2 알림 권한 거부 시

```
[알림 권한 요청]
      │
      ├── 허용 ──► [푸시 알림 활성화]
      │
      └── 거부 ──► [인앱 알림으로 대체]
                        │
                        ▼
                   [앱 열 때 알림 표시]
```

---

## 9. 관련 문서

| 문서 | 설명 |
|------|------|
| [ARCHITECTURE.md](./ARCHITECTURE.md) | 시스템 아키텍처 |
| [TECH-DECISIONS.md](./TECH-DECISIONS.md) | 기술 선택 |
| `.claude/rules/error-handling-patterns.md` | 에러 처리 패턴 |

---

**Version**: 1.0 | **Created**: 2026-01-16
