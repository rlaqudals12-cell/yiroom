# P0-3-R1: í™˜ê²½ë³€ìˆ˜ ë³´ì•ˆ ë° ì‹œí¬ë¦¿ ê´€ë¦¬ ì¢…í•© ê°€ì´ë“œ

## 1. í•µì‹¬ ìš”ì•½

Next.js 16 + Supabase + Clerk + Vercel ìŠ¤íƒì˜ Turborepo ëª¨ë…¸ë ˆí¬ì—ì„œ í™˜ê²½ë³€ìˆ˜ ë³´ì•ˆì˜ í•µì‹¬ì€ **NEXT_PUBLIC_ ì ‘ë‘ì‚¬ ê·œì¹™ ì—„ìˆ˜**, **t3-envë¥¼ í†µí•œ ë¹Œë“œ íƒ€ìž„ ê²€ì¦**, **gitleaks/git-secrets ê¸°ë°˜ ì‚¬ì „ ì»¤ë°‹ í›…**, **Turborepo íŒ¨í‚¤ì§€ë³„ env ê²©ë¦¬**, ê·¸ë¦¬ê³  **Supabase RLS í™œì„±í™”**ìž…ë‹ˆë‹¤. `service_role_key`ëŠ” ì ˆëŒ€ í´ë¼ì´ì–¸íŠ¸ì— ë…¸ì¶œë˜ë©´ ì•ˆ ë˜ë©°, `anon_key`ëŠ” RLSê°€ í™œì„±í™”ëœ ê²½ìš°ì—ë§Œ ì•ˆì „í•©ë‹ˆë‹¤. í™˜ê²½ë³€ìˆ˜ëŠ” ì•±/íŒ¨í‚¤ì§€ ë ˆë²¨ì— ë°°ì¹˜í•˜ê³ , `turbo.json`ì˜ `env` í•„ë“œì— ëª…ì‹œí•´ ìºì‹œ ë¬´ê²°ì„±ì„ ë³´ìž¥í•´ì•¼ í•©ë‹ˆë‹¤.

---

## 2. ìƒì„¸ ë‚´ìš©

### 2.1 Next.js í™˜ê²½ë³€ìˆ˜ ë¶„ë¥˜

**NEXT_PUBLIC_ ì ‘ë‘ì‚¬ì˜ ë™ìž‘ ì›ë¦¬**

`NEXT_PUBLIC_` ì ‘ë‘ì‚¬ê°€ ë¶™ì€ í™˜ê²½ë³€ìˆ˜ëŠ” **ë¹Œë“œ íƒ€ìž„ì— webpack DefinePluginì„ í†µí•´ JavaScript ë²ˆë“¤ì— ì§ì ‘ ì¸ë¼ì¸**ë©ë‹ˆë‹¤. ì´ëŠ” í´ë¼ì´ì–¸íŠ¸ ë²ˆë“¤ì— ë¬¸ìžì—´ ê°’ ìžì²´ê°€ í•˜ë“œì½”ë”©ë˜ì–´ ë¸Œë¼ìš°ì € DevToolsì—ì„œ í™•ì¸ ê°€ëŠ¥í•¨ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.

```javascript
// .env.local
NEXT_PUBLIC_API_URL=https://api.example.com

// ë¹Œë“œ í›„ ì½”ë“œ
setupAnalytics(process.env.NEXT_PUBLIC_API_URL)
// â†’ setupAnalytics('https://api.example.com')  // ê°’ì´ ì§ì ‘ ì¹˜í™˜ë¨
```

ì¤‘ìš”í•œ ì œì•½ì‚¬í•­ìœ¼ë¡œ, **ë™ì  ì ‘ê·¼ íŒ¨í„´ì€ ìž‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤**:
```javascript
// âŒ ìž‘ë™ ì•ˆ í•¨
const key = 'NEXT_PUBLIC_API_URL'
process.env[key]  // undefined

// âœ… ë°˜ë“œì‹œ ì§ì ‘ ì ‘ê·¼
process.env.NEXT_PUBLIC_API_URL  // ì •ìƒ ìž‘ë™
```

**ì„œë²„ ì „ìš© í™˜ê²½ë³€ìˆ˜ ë³´í˜¸ ë©”ì»¤ë‹ˆì¦˜**

`NEXT_PUBLIC_` ì ‘ë‘ì‚¬ê°€ ì—†ëŠ” ëª¨ë“  í™˜ê²½ë³€ìˆ˜ëŠ” ì„œë²„ì—ì„œë§Œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë©°, í´ë¼ì´ì–¸íŠ¸ ë²ˆë“¤ì—ì„œëŠ” ë¹ˆ ê°ì²´(`{}`)ë¡œ ëŒ€ì²´ë©ë‹ˆë‹¤. ì¶”ê°€ì ì¸ ë³´í˜¸ë¥¼ ìœ„í•´ `server-only` íŒ¨í‚¤ì§€ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤:

```typescript
// lib/db.ts
import 'server-only'  // Client Componentì—ì„œ import ì‹œ ë¹Œë“œ ì—ëŸ¬ ë°œìƒ

export async function getSecretData() {
  const apiKey = process.env.SECRET_API_KEY  // ì„œë²„ì—ì„œë§Œ ì ‘ê·¼ ê°€ëŠ¥
  return fetch(API_URL, { headers: { Authorization: apiKey } })
}
```

**í´ë¼ì´ì–¸íŠ¸ ë…¸ì¶œ ìœ„í—˜ ë³€ìˆ˜ ë¶„ë¥˜**

| ë…¸ì¶œ ê¸ˆì§€ (ì„œë²„ ì „ìš©) | ë…¸ì¶œ ê°€ëŠ¥ (NEXT_PUBLIC_) |
|---------------------|------------------------|
| `DATABASE_URL` | `NEXT_PUBLIC_SUPABASE_URL` |
| `SUPABASE_SERVICE_ROLE_KEY` | `NEXT_PUBLIC_SUPABASE_ANON_KEY` (RLS í•„ìˆ˜) |
| `CLERK_SECRET_KEY` | `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY` |
| `JWT_SECRET`, `SESSION_SECRET` | `NEXT_PUBLIC_API_URL` |
| AWS/GCP ì‹œí¬ë¦¿ í‚¤ | Analytics ID, Feature flags |

**Next.js 15/16 í™˜ê²½ë³€ìˆ˜ ë³€ê²½ì‚¬í•­**

Next.js 16(2025ë…„ 10ì›” ì¶œì‹œ)ì—ì„œ ì£¼ìš” ë³€ê²½:
- **`serverRuntimeConfig`/`publicRuntimeConfig` ì™„ì „ ì œê±°** - `.env` íŒŒì¼ ë°©ì‹ìœ¼ë¡œ ì „í™˜ í•„ìˆ˜
- **Server Actions ìžë™ ì•”í˜¸í™”**: í´ë¡œì € ë³€ìˆ˜ê°€ AES-GCMìœ¼ë¡œ ìžë™ ì•”í˜¸í™”ë¨
- ë©€í‹° ì„œë²„ ë°°í¬ ì‹œ `NEXT_SERVER_ACTIONS_ENCRYPTION_KEY` ì„¤ì • í•„ìš”
- App Routerì—ì„œ ëŸ°íƒ€ìž„ í™˜ê²½ë³€ìˆ˜ ì ‘ê·¼ ì‹œ `connection()` í•¨ìˆ˜ ì‚¬ìš©:

```typescript
import { connection } from 'next/server'

export default async function DynamicPage() {
  await connection()  // ë™ì  ë Œë”ë§ í™œì„±í™”
  const runtimeValue = process.env.RUNTIME_SECRET  // ìš”ì²­ë§ˆë‹¤ í‰ê°€ë¨
}
```

---

### 2.2 í•„ìˆ˜ í™˜ê²½ë³€ìˆ˜ ëª©ë¡ ë° ê²€ì¦ íŒ¨í„´

**Supabase ê´€ë ¨ í™˜ê²½ë³€ìˆ˜**

| ë³€ìˆ˜ëª… | ìš©ë„ | ìœ„ì¹˜ | ë³´ì•ˆ ë ˆë²¨ |
|-------|-----|-----|----------|
| `NEXT_PUBLIC_SUPABASE_URL` | API ì—”ë“œí¬ì¸íŠ¸ | í´ë¼ì´ì–¸íŠ¸ | ê³µê°œ ê°€ëŠ¥ |
| `NEXT_PUBLIC_SUPABASE_ANON_KEY` | ìµëª… ì ‘ê·¼ í† í° | í´ë¼ì´ì–¸íŠ¸ | RLS í™œì„±í™” ì‹œ ì•ˆì „ |
| `SUPABASE_SERVICE_ROLE_KEY` | ê´€ë¦¬ìž í† í° (RLS ìš°íšŒ) | ì„œë²„ ì „ìš© | **ì ˆëŒ€ ë…¸ì¶œ ê¸ˆì§€** |
| `SUPABASE_DB_URL` | ì§ì ‘ DB ì—°ê²° | ì„œë²„ ì „ìš© | **ì ˆëŒ€ ë…¸ì¶œ ê¸ˆì§€** |

**Clerk ì¸ì¦ ê´€ë ¨ í™˜ê²½ë³€ìˆ˜**

| ë³€ìˆ˜ëª… | í˜•ì‹ | ìœ„ì¹˜ |
|-------|-----|-----|
| `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY` | `pk_test_*` / `pk_live_*` | í´ë¼ì´ì–¸íŠ¸ |
| `CLERK_SECRET_KEY` | `sk_test_*` / `sk_live_*` | ì„œë²„ ì „ìš© |
| `CLERK_WEBHOOK_SECRET` | ë¬¸ìžì—´ | ì„œë²„ ì „ìš© |

**t3-envë¥¼ í™œìš©í•œ í™˜ê²½ë³€ìˆ˜ ê²€ì¦**

t3-envëŠ” **ë¹Œë“œ íƒ€ìž„ ê²€ì¦**ê³¼ **ëŸ°íƒ€ìž„ íƒ€ìž… ì•ˆì „ì„±**ì„ ëª¨ë‘ ì œê³µí•©ë‹ˆë‹¤:

```typescript
// src/env.ts
import { createEnv } from "@t3-oss/env-nextjs";
import { vercel } from "@t3-oss/env-core/presets-zod";
import { z } from "zod";

export const env = createEnv({
  server: {
    NODE_ENV: z.enum(["development", "test", "production"]).default("development"),
    SUPABASE_SERVICE_ROLE_KEY: z.string().min(1, "Service role key í•„ìˆ˜"),
    CLERK_SECRET_KEY: z
      .string()
      .refine(
        (key) => key.startsWith("sk_test_") || key.startsWith("sk_live_"),
        "CLERK_SECRET_KEYëŠ” sk_test_ ë˜ëŠ” sk_live_ë¡œ ì‹œìž‘í•´ì•¼ í•¨"
      ),
    DATABASE_URL: z.string().url().optional(),
  },

  client: {
    NEXT_PUBLIC_SUPABASE_URL: z.string().url(),
    NEXT_PUBLIC_SUPABASE_ANON_KEY: z.string().min(1),
    NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: z
      .string()
      .refine(
        (key) => key.startsWith("pk_test_") || key.startsWith("pk_live_"),
        "pk_test_ ë˜ëŠ” pk_live_ë¡œ ì‹œìž‘í•´ì•¼ í•¨"
      ),
  },

  extends: [vercel()],  // VERCEL_URL, VERCEL_ENV ìžë™ í¬í•¨

  runtimeEnv: {
    NODE_ENV: process.env.NODE_ENV,
    SUPABASE_SERVICE_ROLE_KEY: process.env.SUPABASE_SERVICE_ROLE_KEY,
    CLERK_SECRET_KEY: process.env.CLERK_SECRET_KEY,
    DATABASE_URL: process.env.DATABASE_URL,
    NEXT_PUBLIC_SUPABASE_URL: process.env.NEXT_PUBLIC_SUPABASE_URL,
    NEXT_PUBLIC_SUPABASE_ANON_KEY: process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,
    NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: process.env.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY,
  },

  emptyStringAsUndefined: true,
  skipValidation: !!process.env.SKIP_ENV_VALIDATION,

  onValidationError: (issues) => {
    console.error("âŒ í™˜ê²½ë³€ìˆ˜ ê²€ì¦ ì‹¤íŒ¨:");
    issues.forEach((issue) => console.error(`  - ${issue.path?.join(".")}: ${issue.message}`));
    throw new Error("í™˜ê²½ë³€ìˆ˜ ê²€ì¦ ì‹¤íŒ¨");
  },

  onInvalidAccess: (variable) => {
    throw new Error(`âŒ ì„œë²„ ì „ìš© ë³€ìˆ˜ "${variable}"ì„ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì ‘ê·¼ ì‹œë„`);
  },
});
```

**ë¹Œë“œ íƒ€ìž„ ê²€ì¦ í™œì„±í™”** (`next.config.ts`ì—ì„œ import):

```typescript
// next.config.ts
import "./src/env";  // ë¹Œë“œ ì‹œ í™˜ê²½ë³€ìˆ˜ ê²€ì¦ ì‹¤í–‰

import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  // ì„¤ì •...
};

export default nextConfig;
```

---

### 2.3 ì‹œí¬ë¦¿ ë…¸ì¶œ ë°©ì§€ íŒ¨í„´

**ì™„ì „í•œ .gitignore íŒ¨í„´**

```gitignore
# í™˜ê²½ë³€ìˆ˜ íŒŒì¼ - í•„ìˆ˜
.env
.env.*
.env.local
.env.development.local
.env.test.local
.env.production.local
.env.staging

# í…œí”Œë¦¿ íŒŒì¼ì€ ì»¤ë°‹ í—ˆìš©
!.env.example
!.env.sample

# ì¸ì¦ì„œ ë° í‚¤ íŒŒì¼
*.pem
*.pfx
*.key
*.p12
credentials.*
secrets.*
```

**gitleaks + pre-commit ì„¤ì •**

```yaml
# .pre-commit-config.yaml
repos:
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.4.0
    hooks:
      - id: check-yaml
      - id: detect-private-key
      - id: detect-aws-credentials

  - repo: https://github.com/gitleaks/gitleaks
    rev: v8.24.2
    hooks:
      - id: gitleaks
```

ì„¤ì¹˜ ë° ì‹¤í–‰:
```bash
pip install pre-commit
pre-commit install
pre-commit autoupdate
```

**Pino ë¡œê±° ì‹œí¬ë¦¿ ë§ˆìŠ¤í‚¹**

```javascript
const pino = require('pino');

const logger = pino({
  redact: {
    paths: [
      'password',
      'apiKey',
      'secret',
      'token',
      'authorization',
      'req.headers.authorization',
      'req.headers.cookie',
      'req.body.password',
      '*.serviceRoleKey',
      '*.secretKey'
    ],
    censor: '[REDACTED]',
  }
});
```

**Sentry ì—ëŸ¬ í•„í„°ë§**

```javascript
import * as Sentry from '@sentry/nextjs';

Sentry.init({
  dsn: process.env.SENTRY_DSN,
  
  beforeSend(event) {
    // ë¯¼ê°í•œ í—¤ë” ì œê±°
    if (event.request?.headers) {
      delete event.request.headers.authorization;
      delete event.request.headers.cookie;
    }
    
    // ì—ëŸ¬ ë©”ì‹œì§€ì—ì„œ ì‹œí¬ë¦¿ íŒ¨í„´ ì œê±°
    if (event.exception?.values) {
      event.exception.values.forEach(exception => {
        if (exception.value) {
          exception.value = exception.value
            .replace(/api[_-]?key[=:]\s*['"]?[\w-]+['"]?/gi, 'api_key=[FILTERED]')
            .replace(/sk_[a-zA-Z0-9_-]+/gi, '[FILTERED_SECRET_KEY]')
            .replace(/eyJhbG[A-Za-z0-9_-]+/gi, '[FILTERED_JWT]');
        }
      });
    }
    return event;
  },
});
```

**ì‹œí¬ë¦¿ ìœ ì¶œ ì‹œ ëŒ€ì‘ ì ˆì°¨**

1. **ì¦‰ì‹œ í‚¤ ë¡œí…Œì´ì…˜** - ë…¸ì¶œëœ ì‹œí¬ë¦¿ ì¦‰ì‹œ ë¬´íš¨í™”
2. **ëª¨ë“  í™˜ê²½ ì—…ë°ì´íŠ¸** - CI/CD, Vercel, ë¡œì»¬ í™˜ê²½
3. **BFG Repo Cleanerë¡œ ížˆìŠ¤í† ë¦¬ ì •ë¦¬**:
```bash
# secrets.txtì— ì œê±°í•  ì‹œí¬ë¦¿ ëª©ë¡ ìž‘ì„±
java -jar bfg.jar --replace-text secrets.txt repo.git
git reflog expire --expire=now --all
git gc --prune=now --aggressive
git push origin --force --all
```
4. **GitHub Secret Scanning ì•Œë¦¼ í™•ì¸ ë° í•´ê²°**

---

### 2.4 í™˜ê²½ë³„ ì„¤ì • ê´€ë¦¬ (Turborepo)

**ê¶Œìž¥ íŒŒì¼ êµ¬ì¡°**

Turborepoì—ì„œëŠ” **ë£¨íŠ¸ê°€ ì•„ë‹Œ íŒ¨í‚¤ì§€/ì•± ë ˆë²¨**ì— `.env` íŒŒì¼ì„ ë°°ì¹˜í•©ë‹ˆë‹¤:

```
my-monorepo/
â”œâ”€â”€ turbo.json                      # ë£¨íŠ¸ ì„¤ì •
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ web/                        # Next.js ì•±
â”‚   â”‚   â”œâ”€â”€ .env                    # ê¸°ë³¸ê°’ (ì»¤ë°‹ ê°€ëŠ¥, ì‹œí¬ë¦¿ ì—†ìŒ)
â”‚   â”‚   â”œâ”€â”€ .env.development        # ê°œë°œ í™˜ê²½
â”‚   â”‚   â”œâ”€â”€ .env.staging            # ìŠ¤í…Œì´ì§• í™˜ê²½
â”‚   â”‚   â”œâ”€â”€ .env.production         # í”„ë¡œë•ì…˜ í”Œë ˆì´ìŠ¤í™€ë”
â”‚   â”‚   â”œâ”€â”€ .env.local              # ë¡œì»¬ ì˜¤ë²„ë¼ì´ë“œ (gitignore)
â”‚   â”‚   â”œâ”€â”€ .env.example            # í…œí”Œë¦¿
â”‚   â”‚   â””â”€â”€ turbo.json              # íŒ¨í‚¤ì§€ë³„ ì„¤ì •
â”‚   â””â”€â”€ api/
â”‚       â”œâ”€â”€ .env.*
â”‚       â””â”€â”€ turbo.json
â””â”€â”€ packages/
    â””â”€â”€ shared/
```

**í™˜ê²½ë³€ìˆ˜ ìš°ì„ ìˆœìœ„** (ë†’ì€ ê²ƒì´ ìš°ì„ ):
1. `.env.development.local` (ê°œë°œ ì‹œ)
2. `.env.local`
3. `.env.development`
4. `.env`

**turbo.json ì„¤ì •**

ë£¨íŠ¸ `turbo.json`:
```json
{
  "$schema": "https://turbo.build/schema.json",
  "globalDependencies": ["tsconfig.base.json"],
  "globalEnv": ["NODE_ENV", "CI"],
  "globalPassThroughEnv": ["VERCEL_*", "GITHUB_TOKEN"],
  "tasks": {
    "build": {
      "dependsOn": ["^build"],
      "inputs": ["$TURBO_DEFAULT$", ".env*"],
      "outputs": ["dist/**"]
    },
    "dev": {
      "cache": false,
      "persistent": true
    }
  }
}
```

ì•±ë³„ `apps/web/turbo.json`:
```json
{
  "$schema": "https://turbo.build/schema.json",
  "extends": ["//"],
  "tasks": {
    "build": {
      "outputs": ["$TURBO_EXTENDS$", ".next/**", "!.next/cache/**"],
      "env": [
        "NEXT_PUBLIC_SUPABASE_URL",
        "NEXT_PUBLIC_SUPABASE_ANON_KEY",
        "NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY"
      ]
    }
  }
}
```

**ìºì‹±ê³¼ í™˜ê²½ë³€ìˆ˜ì˜ ê´€ê³„**

`env`ë‚˜ `globalEnv`ì— ì„ ì–¸ëœ ë³€ìˆ˜ì˜ ê°’ì´ ë³€ê²½ë˜ë©´ í•´ë‹¹ íƒœìŠ¤í¬ì˜ ìºì‹œê°€ ë¬´íš¨í™”ë©ë‹ˆë‹¤. **ì„ ì–¸í•˜ì§€ ì•Šìœ¼ë©´ ë‹¤ë¥¸ í™˜ê²½ì˜ ìºì‹œê°€ ìž˜ëª» ì‚¬ìš©ë  ìœ„í—˜**ì´ ìžˆìŠµë‹ˆë‹¤:

```
# ìœ„í—˜í•œ ì‹œë‚˜ë¦¬ì˜¤
NEXT_PUBLIC_API_URL=staging.api.com â†’ ë¹Œë“œ â†’ ìºì‹œ ì €ìž¥
NEXT_PUBLIC_API_URL=prod.api.com â†’ ë¹Œë“œ â†’ ìºì‹œ ížˆíŠ¸(ìž˜ëª»ëœ ìºì‹œ!)
```

---

### 2.5 í”Œëž«í¼ë³„ Best Practice

**Vercel í™˜ê²½ë³€ìˆ˜ ì„¤ì •**

| í™˜ê²½ | ìš©ë„ | ë°°í¬ íŠ¸ë¦¬ê±° |
|-----|-----|-----------|
| **Production** | í”„ë¡œë•ì…˜ ë¸Œëžœì¹˜(main) ë°°í¬ | `vercel deploy --prod` |
| **Preview** | ë¹„-í”„ë¡œë•ì…˜ ë¸Œëžœì¹˜ ë°°í¬ | `vercel deploy` |
| **Development** | ë¡œì»¬ ê°œë°œ (`vercel dev`) | - |

CLI ëª…ë ¹ì–´:
```bash
# ë¡œì»¬ì— í™˜ê²½ë³€ìˆ˜ ê°€ì ¸ì˜¤ê¸°
vercel env pull .env.local

# í™˜ê²½ë³„ ë³€ìˆ˜ ì¶”ê°€
vercel env add DATABASE_URL production
vercel env add DATABASE_URL preview --sensitive

# ë³€ìˆ˜ ëª©ë¡ í™•ì¸
vercel env ls production
```

**ë¯¼ê°í•œ ë³€ìˆ˜ ì„¤ì •**: Dashboardì—ì„œ "Sensitive" ì²´í¬ ì‹œ ê°’ì´ ì˜êµ¬ì ìœ¼ë¡œ ìˆ¨ê²¨ì§€ë©° ë³µí˜¸í™” ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.

**Supabase í‚¤ ë³´ì•ˆ**

| í‚¤ íƒ€ìž… | RLS ë™ìž‘ | í´ë¼ì´ì–¸íŠ¸ ë…¸ì¶œ | ì‚¬ìš© ìœ„ì¹˜ |
|--------|---------|---------------|---------|
| `anon_key` | RLS ì •ì±… ì ìš© | âœ… (RLS í•„ìˆ˜) | í´ë¼ì´ì–¸íŠ¸ SDK |
| `service_role_key` | **RLS ìš°íšŒ** | âŒ ì ˆëŒ€ ê¸ˆì§€ | ì„œë²„ ì „ìš© (API Routes, Edge Functions) |

**RLS ì—†ì´ anon_key ë…¸ì¶œ = ì „ì²´ ë°ì´í„° ë…¸ì¶œ**. ë°˜ë“œì‹œ ëª¨ë“  í…Œì´ë¸”ì— RLS í™œì„±í™”:

```sql
-- RLS í™œì„±í™”
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;

-- ì •ì±… ì˜ˆì‹œ: ë³¸ì¸ ë°ì´í„°ë§Œ ì¡°íšŒ
CREATE POLICY "Users can view own profile"
ON public.profiles FOR SELECT
TO authenticated
USING (auth.uid() = id);
```

**í‚¤ ë¡œí…Œì´ì…˜ ì „ëžµ**

Supabaseì˜ ìƒˆë¡œìš´ API í‚¤ ì‹œìŠ¤í…œ(`sb_publishable_*`, `sb_secret_*`)ì€ ì œë¡œ ë‹¤ìš´íƒ€ìž„ ë¡œí…Œì´ì…˜ ì§€ì›:

1. Dashboardì—ì„œ ìƒˆ ì‹œí¬ë¦¿ í‚¤ ìƒì„± (ê¸°ì¡´ í‚¤ì™€ ë™ì‹œ ìž‘ë™)
2. ì„œë²„ ë°°í¬ì— ìƒˆ í‚¤ ì ìš©
3. Dashboardì—ì„œ "last used" í™•ì¸
4. ê¸°ì¡´ í‚¤ ì‚¬ìš©ëŸ‰ 0 í™•ì¸ í›„ ì‚­ì œ

```typescript
// ë“€ì–¼ í‚¤ íŒ¨í„´ (ì „í™˜ ê¸°ê°„)
const supabaseSecretKey = 
  process.env.SUPABASE_SECRET_KEY ||      // ìƒˆ í‚¤ ìš°ì„ 
  process.env.SUPABASE_SERVICE_ROLE_KEY;  // ë ˆê±°ì‹œ í´ë°±
```

---

## 3. êµ¬í˜„ ì‹œ í•„ìˆ˜ ì‚¬í•­

### í™˜ê²½ë³€ìˆ˜ ë³´ì•ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] **NEXT_PUBLIC_ ì ‘ë‘ì‚¬ ê²€í† **: ë¯¼ê°í•œ ë³€ìˆ˜ì— ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
- [ ] **t3-env ì„¤ì •**: `src/env.ts` ìƒì„± ë° `next.config.ts`ì—ì„œ import
- [ ] **Supabase RLS í™œì„±í™”**: ëª¨ë“  public ìŠ¤í‚¤ë§ˆ í…Œì´ë¸”ì— ì •ì±… ì ìš©
- [ ] **service_role_key ê²©ë¦¬**: ì„œë²„ ì „ìš© ì½”ë“œì—ì„œë§Œ ì‚¬ìš©, `server-only` íŒ¨í‚¤ì§€ ì ìš©

### Git ë³´ì•ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] **.gitignore ì„¤ì •**: `.env*` íŒ¨í„´ ì¶”ê°€, `.env.example` ì œì™¸
- [ ] **gitleaks ì„¤ì¹˜**: pre-commit hook ì„¤ì •
- [ ] **git-secrets ì„¤ì •**: AWS íŒ¨í„´ ë“±ë¡ (`git secrets --register-aws`)
- [ ] **GitHub Secret Scanning í™œì„±í™”**: Push Protection ì¼œê¸°

### Turborepo ì„¤ì • ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] **turbo.json env ì„ ì–¸**: ë¹Œë“œì— ì˜í–¥ ì£¼ëŠ” ëª¨ë“  í™˜ê²½ë³€ìˆ˜ ëª…ì‹œ
- [ ] **íŒ¨í‚¤ì§€ë³„ turbo.json**: `extends: ["//"]`ë¡œ ë£¨íŠ¸ ì„¤ì • ìƒì†
- [ ] **inputsì— .env* í¬í•¨**: íŒŒì¼ ë³€ê²½ ì‹œ ìºì‹œ ë¬´íš¨í™”
- [ ] **.env íŒŒì¼ ì•± ë ˆë²¨ ë°°ì¹˜**: ë£¨íŠ¸ê°€ ì•„ë‹Œ apps/packages ë‚´ë¶€

### ë°°í¬ í™˜ê²½ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] **Vercel í™˜ê²½ ë¶„ë¦¬**: Production/Preview/Development ë³„ë„ ì„¤ì •
- [ ] **ë¯¼ê°í•œ ë³€ìˆ˜ í‘œì‹œ**: Vercel Dashboardì—ì„œ Sensitive ì²´í¬
- [ ] **í‚¤ ë¡œí…Œì´ì…˜ ê³„íš**: ë¶„ê¸°ë³„ ë˜ëŠ” ì¸ì‹œë˜íŠ¸ ì‹œ ë¡œí…Œì´ì…˜ ì ˆì°¨ ë¬¸ì„œí™”
- [ ] **ë¡œê·¸ ë§ˆìŠ¤í‚¹**: Pino/Winstonì— redact ì„¤ì • ì ìš©

---

## 4. ì½”ë“œ ì˜ˆì‹œ

### í™˜ê²½ë³€ìˆ˜ ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸ (ì „ì²´ ì„¤ì •)

```typescript
// src/env.ts - ì™„ì „í•œ t3-env ì„¤ì •
import { createEnv } from "@t3-oss/env-nextjs";
import { vercel } from "@t3-oss/env-core/presets-zod";
import { z } from "zod";

export const env = createEnv({
  server: {
    NODE_ENV: z.enum(["development", "test", "production"]).default("development"),
    
    // Supabase ì„œë²„
    SUPABASE_SERVICE_ROLE_KEY: z.string().min(1),
    DATABASE_URL: z.string().url().optional(),
    
    // Clerk ì„œë²„
    CLERK_SECRET_KEY: z.string().refine(
      (k) => k.startsWith("sk_test_") || k.startsWith("sk_live_"),
      "Invalid Clerk secret key format"
    ),
    CLERK_WEBHOOK_SECRET: z.string().optional(),
  },

  client: {
    // Supabase í´ë¼ì´ì–¸íŠ¸
    NEXT_PUBLIC_SUPABASE_URL: z.string().url(),
    NEXT_PUBLIC_SUPABASE_ANON_KEY: z.string().min(1),
    
    // Clerk í´ë¼ì´ì–¸íŠ¸
    NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: z.string().refine(
      (k) => k.startsWith("pk_test_") || k.startsWith("pk_live_"),
      "Invalid Clerk publishable key format"
    ),
    NEXT_PUBLIC_CLERK_SIGN_IN_URL: z.string().optional(),
    NEXT_PUBLIC_CLERK_SIGN_UP_URL: z.string().optional(),
  },

  shared: {
    NEXT_PUBLIC_VERCEL_ENV: z.enum(["production", "preview", "development"]).optional(),
  },

  extends: [vercel()],

  runtimeEnv: {
    NODE_ENV: process.env.NODE_ENV,
    SUPABASE_SERVICE_ROLE_KEY: process.env.SUPABASE_SERVICE_ROLE_KEY,
    DATABASE_URL: process.env.DATABASE_URL,
    CLERK_SECRET_KEY: process.env.CLERK_SECRET_KEY,
    CLERK_WEBHOOK_SECRET: process.env.CLERK_WEBHOOK_SECRET,
    NEXT_PUBLIC_SUPABASE_URL: process.env.NEXT_PUBLIC_SUPABASE_URL,
    NEXT_PUBLIC_SUPABASE_ANON_KEY: process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,
    NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: process.env.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY,
    NEXT_PUBLIC_CLERK_SIGN_IN_URL: process.env.NEXT_PUBLIC_CLERK_SIGN_IN_URL,
    NEXT_PUBLIC_CLERK_SIGN_UP_URL: process.env.NEXT_PUBLIC_CLERK_SIGN_UP_URL,
    NEXT_PUBLIC_VERCEL_ENV: process.env.NEXT_PUBLIC_VERCEL_ENV,
  },

  emptyStringAsUndefined: true,
  skipValidation: !!process.env.SKIP_ENV_VALIDATION || process.env.npm_lifecycle_event === "lint",

  onValidationError: (issues) => {
    console.error("âŒ í™˜ê²½ë³€ìˆ˜ ê²€ì¦ ì‹¤íŒ¨:");
    issues.forEach((issue) => {
      console.error(`  - ${issue.path?.join(".")}: ${issue.message}`);
    });
    process.exit(1);
  },

  onInvalidAccess: (variable) => {
    throw new Error(`âŒ ì„œë²„ ì „ìš© ë³€ìˆ˜ "${variable}"ë¥¼ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì ‘ê·¼ ì‹œë„`);
  },
});

// íƒ€ìž… export
export type Env = typeof env;
```

### Supabase í´ë¼ì´ì–¸íŠ¸ ì„¤ì •

```typescript
// lib/supabase/client.ts - í´ë¼ì´ì–¸íŠ¸ìš© (ë¸Œë¼ìš°ì €)
import { createBrowserClient } from "@supabase/ssr";
import { env } from "@/env";

export const createClient = () =>
  createBrowserClient(
    env.NEXT_PUBLIC_SUPABASE_URL,
    env.NEXT_PUBLIC_SUPABASE_ANON_KEY
  );

// lib/supabase/server.ts - ì„œë²„ìš© (API Routes, Server Components)
import "server-only";
import { createClient } from "@supabase/supabase-js";
import { env } from "@/env";

export const supabaseAdmin = createClient(
  env.NEXT_PUBLIC_SUPABASE_URL,
  env.SUPABASE_SERVICE_ROLE_KEY,
  {
    auth: {
      autoRefreshToken: false,
      persistSession: false,
    },
  }
);
```

### Turborepo ì„¤ì • ì˜ˆì‹œ

```json
// turbo.json (ë£¨íŠ¸)
{
  "$schema": "https://turbo.build/schema.json",
  "globalDependencies": ["tsconfig.base.json"],
  "globalEnv": ["NODE_ENV", "CI"],
  "globalPassThroughEnv": ["VERCEL_*", "GITHUB_TOKEN"],
  "tasks": {
    "build": {
      "dependsOn": ["^build"],
      "inputs": ["$TURBO_DEFAULT$", ".env*"],
      "outputs": ["dist/**"]
    },
    "dev": { "cache": false, "persistent": true },
    "lint": { "outputs": [] },
    "typecheck": { "outputs": [] }
  }
}
```

```json
// apps/web/turbo.json
{
  "$schema": "https://turbo.build/schema.json",
  "extends": ["//"],
  "tasks": {
    "build": {
      "outputs": ["$TURBO_EXTENDS$", ".next/**", "!.next/cache/**"],
      "env": [
        "NEXT_PUBLIC_SUPABASE_URL",
        "NEXT_PUBLIC_SUPABASE_ANON_KEY",
        "NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY"
      ]
    }
  }
}
```

### ë³´ì•ˆ ì…‹ì—… ìŠ¤í¬ë¦½íŠ¸

```bash
#!/bin/bash
# scripts/security-setup.sh

set -e

echo "ðŸ” ë³´ì•ˆ ë„êµ¬ ì„¤ì¹˜ ì¤‘..."

# pre-commit ì„¤ì¹˜
pip install pre-commit

# gitleaks ì„¤ì¹˜ (macOS)
if [[ "$OSTYPE" == "darwin"* ]]; then
    brew install gitleaks git-secrets
fi

# .pre-commit-config.yaml ìƒì„±
cat > .pre-commit-config.yaml << 'EOF'
repos:
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.4.0
    hooks:
      - id: check-yaml
      - id: detect-private-key
      - id: detect-aws-credentials

  - repo: https://github.com/gitleaks/gitleaks
    rev: v8.24.2
    hooks:
      - id: gitleaks
EOF

# git-secrets AWS íŒ¨í„´ ë“±ë¡
git secrets --install || true
git secrets --register-aws || true

# pre-commit í›… ì„¤ì¹˜
pre-commit install

echo "âœ… ë³´ì•ˆ ì„¤ì • ì™„ë£Œ!"
```

---

## 5. ì°¸ê³  ìžë£Œ

**ê³µì‹ ë¬¸ì„œ**
- Next.js Environment Variables: nextjs.org/docs/pages/guides/environment-variables
- Next.js 16 Release Notes: nextjs.org/blog/next-16
- Turborepo Environment Variables: turbo.build/repo/docs/crafting-your-repository/using-environment-variables
- t3-env Documentation: env.t3.gg/docs/nextjs
- Supabase API Keys: supabase.com/docs/guides/api/api-keys
- Supabase RLS: supabase.com/docs/guides/database/postgres/row-level-security
- Clerk Environment Variables: clerk.com/docs/deployments/clerk-environment-variables
- Vercel Environment Variables: vercel.com/docs/environment-variables

**ë³´ì•ˆ ë„êµ¬**
- gitleaks: github.com/gitleaks/gitleaks
- git-secrets: github.com/awslabs/git-secrets
- BFG Repo-Cleaner: rtyley.github.io/bfg-repo-cleaner
- GitHub Secret Scanning: docs.github.com/code-security/secret-scanning

**ì¶”ê°€ ê°€ì´ë“œ**
- Next.js Security Best Practices: nextjs.org/docs/app/guides/data-security
- Supabase Security Advisor: Dashboard > Security > Security Advisor
- Vercel Edge Config: vercel.com/docs/edge-config