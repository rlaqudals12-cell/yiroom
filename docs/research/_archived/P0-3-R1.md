# P0-3-R1: í™˜ê²½ë³€ìˆ˜ ë³´ì•ˆ

## 1. í•µì‹¬ ìš”ì•½

Next.js 16ì—ì„œ í™˜ê²½ë³€ìˆ˜ ë³´ì•ˆì€ **NEXT_PUBLIC_ ì ‘ë‘ì‚¬ ì‚¬ìš© ê·œì¹™ ì¤€ìˆ˜**, **t3-envë¥¼ í†µí•œ íƒ€ì… ì•ˆì „ ê²€ì¦**, **pre-commit hooksë¥¼ í†µí•œ ë¹„ë°€í‚¤ ìœ ì¶œ ë°©ì§€**ê°€ í•µì‹¬ì…ë‹ˆë‹¤. `NEXT_PUBLIC_` ì ‘ë‘ì‚¬ê°€ ë¶™ì€ ë³€ìˆ˜ëŠ” ë¹Œë“œ ì‹œ í´ë¼ì´ì–¸íŠ¸ ë²ˆë“¤ì— í•˜ë“œì½”ë”©ë˜ì–´ ë¸Œë¼ìš°ì €ì— ë…¸ì¶œë˜ë¯€ë¡œ, **API í‚¤ë‚˜ DB ë¹„ë°€ë²ˆí˜¸ëŠ” ì ˆëŒ€ ì´ ì ‘ë‘ì‚¬ë¥¼ ì‚¬ìš©í•˜ë©´ ì•ˆ ë©ë‹ˆë‹¤**. Vercelê³¼ GitHub ActionsëŠ” í™˜ê²½ë³„(Production/Preview/Development) ì‹œí¬ë¦¿ ë¶„ë¦¬ë¥¼ ì§€ì›í•˜ë©°, OIDC ê¸°ë°˜ ì¸ì¦ìœ¼ë¡œ ì¥ê¸° í† í° ì €ì¥ ì—†ì´ ì•ˆì „í•œ CI/CD íŒŒì´í”„ë¼ì¸ì„ êµ¬ì¶•í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. íŒ€ í˜‘ì—… ì‹œì—ëŠ” `.env.example` í…œí”Œë¦¿ê³¼ Doppler, 1Password ê°™ì€ ì‹œí¬ë¦¿ ê´€ë¦¬ ë„êµ¬ë¥¼ ì¡°í•©í•˜ì—¬ ë³´ì•ˆê³¼ í¸ì˜ì„±ì˜ ê· í˜•ì„ ë§ì¶”ëŠ” ê²ƒì´ ê¶Œì¥ë©ë‹ˆë‹¤.

---

## 2. ìƒì„¸ ë‚´ìš©

### 2.1 Next.js í™˜ê²½ë³€ìˆ˜ ìœ í˜•

Next.jsëŠ” í™˜ê²½ë³€ìˆ˜ë¥¼ **NEXT_PUBLIC_ ì ‘ë‘ì‚¬ ìœ ë¬´**ì— ë”°ë¼ í´ë¼ì´ì–¸íŠ¸ ë…¸ì¶œ ì—¬ë¶€ë¥¼ ê²°ì •í•©ë‹ˆë‹¤. ì´ êµ¬ë¶„ì€ ë³´ì•ˆì˜ í•µì‹¬ì…ë‹ˆë‹¤.

| íŠ¹ì„± | `NEXT_PUBLIC_*` í™˜ê²½ë³€ìˆ˜ | ì„œë²„ ì „ìš© í™˜ê²½ë³€ìˆ˜ |
|------|-------------------------|-------------------|
| **ì ‘ê·¼ ìœ„ì¹˜** | ì„œë²„ + í´ë¼ì´ì–¸íŠ¸(ë¸Œë¼ìš°ì €) | ì„œë²„ë§Œ (Node.js) |
| **ì²˜ë¦¬ ì‹œì ** | ë¹Œë“œ íƒ€ì„ì— í•˜ë“œì½”ë”© | ëŸ°íƒ€ì„ì— ë™ì  ì ‘ê·¼ |
| **ë²ˆë“¤ í¬í•¨** | JavaScript ë²ˆë“¤ì— ì¸ë¼ì¸ | ë²ˆë“¤ì— í¬í•¨ ì•ˆë¨ |
| **ë³€ê²½ ë°˜ì˜** | ì¬ë¹Œë“œ í•„ìš” | ì„œë²„ ì¬ì‹œì‘ìœ¼ë¡œ ë°˜ì˜ |
| **ì‚¬ìš© ì˜ˆì‹œ** | `NEXT_PUBLIC_API_URL` | `DATABASE_URL`, `API_SECRET` |

**í´ë¼ì´ì–¸íŠ¸ ë²ˆë“¤ë§ ë™ì‘ ë°©ì‹**: Next.jsëŠ” Webpackì˜ `DefinePlugin`ì„ ì‚¬ìš©í•˜ì—¬ `NEXT_PUBLIC_*` ë³€ìˆ˜ë¥¼ ë¹Œë“œ ì‹œì ì— ì‹¤ì œ ê°’ìœ¼ë¡œ ì¹˜í™˜í•©ë‹ˆë‹¤. `process.env.NEXT_PUBLIC_API_URL`ì´ë¼ê³  ì‘ì„±í•˜ë©´ ë¹Œë“œ í›„ `"https://api.example.com"`ì²˜ëŸ¼ ë¦¬í„°ëŸ´ ê°’ìœ¼ë¡œ ëŒ€ì²´ë©ë‹ˆë‹¤. ì£¼ì˜í•  ì ì€ **ë™ì  ì ‘ê·¼**(ì˜ˆ: `process.env[varName]`)ì€ ì¸ë¼ì¸ë˜ì§€ ì•Šì•„ `undefined`ë¥¼ ë°˜í™˜í•œë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤.

**App Router(Next.js 16)ì—ì„œì˜ ì²˜ë¦¬**:
- **Server Components**: ëª¨ë“  í™˜ê²½ë³€ìˆ˜ì— ëŸ°íƒ€ì„ ì ‘ê·¼ ê°€ëŠ¥
- **Client Components**: `NEXT_PUBLIC_*` ë³€ìˆ˜ë§Œ ì ‘ê·¼ ê°€ëŠ¥
- **Server Actions/Route Handlers**: ëª¨ë“  í™˜ê²½ë³€ìˆ˜ì— ì•ˆì „í•˜ê²Œ ì ‘ê·¼

```typescript
// âœ… ì„œë²„ ì „ìš© ì½”ë“œ ë³´í˜¸ - import ì‹œ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë¹Œë“œ ì—ëŸ¬ ë°œìƒ
import 'server-only';

export async function getUser(id: string) {
  const db = await connect(process.env.DATABASE_URL); // ì„œë²„ì—ì„œë§Œ ì ‘ê·¼
  return db.query(`SELECT * FROM users WHERE id = $1`, [id]);
}
```

---

### 2.2 ê²€ì¦ íŒ¨í„´

í™˜ê²½ë³€ìˆ˜ ê²€ì¦ì€ **ë¹Œë“œ íƒ€ì„ ê²€ì¦**ê³¼ **ëŸ°íƒ€ì„ ê²€ì¦** ë‘ ê°€ì§€ ë°©ì‹ì´ ìˆìœ¼ë©°, **t3-env** ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” ë‘ ê°€ì§€ ì¥ì ì„ ëª¨ë‘ ì œê³µí•©ë‹ˆë‹¤.

| êµ¬ë¶„ | ë¹Œë“œ íƒ€ì„ ê²€ì¦ | ëŸ°íƒ€ì„ ê²€ì¦ |
|------|---------------|-------------|
| **ê²€ì¦ ì‹œì ** | `next build` ì‹¤í–‰ ì‹œ | ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ì‹œ |
| **ì¥ì ** | ë°°í¬ ì „ ì˜¤ë¥˜ ì¡°ê¸° ë°œê²¬, CI/CDì—ì„œ ì‹¤íŒ¨ ê°ì§€ | Docker ë©€í‹° í™˜ê²½ ë°°í¬ ìš©ì´, ë™ì  ì„¤ì • ì§€ì› |
| **ë‹¨ì ** | í™˜ê²½ë³„ ë³„ë„ ë¹Œë“œ í•„ìš” | ì‹¤í–‰ ì „ê¹Œì§€ ì˜¤ë¥˜ ê°ì§€ ë¶ˆê°€ |

**t3-env ì„¤ì • ì˜ˆì‹œ**:

```typescript
// src/env.ts
import { createEnv } from "@t3-oss/env-nextjs";
import { z } from "zod";

export const env = createEnv({
  // ì„œë²„ ì‚¬ì´ë“œ í™˜ê²½ë³€ìˆ˜ (í´ë¼ì´ì–¸íŠ¸ ì ‘ê·¼ ì‹œ ì—ëŸ¬)
  server: {
    DATABASE_URL: z.string().url(),
    AUTH_SECRET: z.string().min(32),
    OPENAI_API_KEY: z.string().min(1),
    NODE_ENV: z.enum(['development', 'test', 'production']).default('development'),
  },

  // í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ í™˜ê²½ë³€ìˆ˜ (NEXT_PUBLIC_ ì ‘ë‘ì‚¬ í•„ìˆ˜)
  client: {
    NEXT_PUBLIC_APP_URL: z.string().url(),
    NEXT_PUBLIC_SUPABASE_URL: z.string().url(),
    NEXT_PUBLIC_SUPABASE_ANON_KEY: z.string().min(1),
  },

  runtimeEnv: {
    DATABASE_URL: process.env.DATABASE_URL,
    AUTH_SECRET: process.env.AUTH_SECRET,
    OPENAI_API_KEY: process.env.OPENAI_API_KEY,
    NODE_ENV: process.env.NODE_ENV,
    NEXT_PUBLIC_APP_URL: process.env.NEXT_PUBLIC_APP_URL,
    NEXT_PUBLIC_SUPABASE_URL: process.env.NEXT_PUBLIC_SUPABASE_URL,
    NEXT_PUBLIC_SUPABASE_ANON_KEY: process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,
  },

  // ë¹ˆ ë¬¸ìì—´ì„ undefinedë¡œ ì²˜ë¦¬
  emptyStringAsUndefined: true,
  
  // Docker ë¹Œë“œ ë“±ì—ì„œ ê²€ì¦ ê±´ë„ˆë›°ê¸°
  skipValidation: process.env.SKIP_ENV_VALIDATION === 'true',
  
  // ê²€ì¦ ì‹¤íŒ¨ ì‹œ ì»¤ìŠ¤í…€ ì—ëŸ¬ í•¸ë“¤ëŸ¬
  onValidationError: (issues) => {
    console.error('âŒ í™˜ê²½ë³€ìˆ˜ ê²€ì¦ ì‹¤íŒ¨:');
    issues.forEach(issue => console.error(`  - ${issue.path}: ${issue.message}`));
    throw new Error('í™˜ê²½ë³€ìˆ˜ë¥¼ í™•ì¸í•˜ì„¸ìš”. ì°¸ê³ : .env.example');
  },

  // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì„œë²„ ë³€ìˆ˜ ì ‘ê·¼ ì‹œ
  onInvalidAccess: (variable) => {
    throw new Error(`ğŸš« í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì„œë²„ ì „ìš© í™˜ê²½ë³€ìˆ˜ "${variable}" ì ‘ê·¼ ì‹œë„`);
  },
});
```

**ë¹Œë“œ íƒ€ì„ ê²€ì¦ í™œì„±í™”** (`next.config.ts`):

```typescript
// next.config.ts
import type { NextConfig } from "next";
import "./src/env"; // ë¹Œë“œ ì‹œ í™˜ê²½ë³€ìˆ˜ ê²€ì¦

const nextConfig: NextConfig = {
  // ì„¤ì •...
};

export default nextConfig;
```

---

### 2.3 ë…¸ì¶œ ë°©ì§€ ì²´í¬ë¦¬ìŠ¤íŠ¸

#### í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ë…¸ì¶œ ë°©ì§€

| ìœ„í—˜ í•­ëª© | ìœ„í—˜ë„ | ë°©ì§€ ë°©ë²• |
|----------|--------|----------|
| `NEXT_PUBLIC_*`ì— API ì‹œí¬ë¦¿ ì €ì¥ | ğŸ”´ ë§¤ìš° ë†’ìŒ | ì„œë²„ ì „ìš© ë³€ìˆ˜ë¡œ ë¶„ë¦¬ |
| í”„ë¡œë•ì…˜ ì†ŒìŠ¤ë§µ ë°°í¬ | ğŸŸ  ë†’ìŒ | `productionBrowserSourceMaps: false` ì„¤ì • |
| í´ë¼ì´ì–¸íŠ¸ ì»´í¬ë„ŒíŠ¸ì— ë¯¼ê° ë°ì´í„° props ì „ë‹¬ | ğŸ”´ ë§¤ìš° ë†’ìŒ | DTO íŒ¨í„´ìœ¼ë¡œ í•„ìš”í•œ í•„ë“œë§Œ ì „ë‹¬ |

#### .gitignore í•„ìˆ˜ ì„¤ì •

```gitignore
# í™˜ê²½ë³€ìˆ˜ íŒŒì¼
.env
.env.local
.env*.local
.env.development.local
.env.production.local

# ë¹„ë°€í‚¤/ì¸ì¦ì„œ
*.pem
*.key
secrets.json

# AWS ìê²©ì¦ëª…
.aws/credentials
```

#### Pre-commit Hook ì„¤ì • (Husky + Gitleaks)

```bash
# ì„¤ì¹˜
npm install --save-dev husky
npx husky init

# .husky/pre-commit íŒŒì¼
#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

npx lint-staged
gitleaks protect --staged --verbose
```

#### ë¡œê·¸ ë§ˆìŠ¤í‚¹ íŒ¨í„´

```typescript
const sensitivePatterns = [
  { pattern: /(?:api[_-]?key|apikey)[=:]\s*['"]?([a-zA-Z0-9_-]{20,})['"]?/gi, replacement: 'API_KEY=***MASKED***' },
  { pattern: /(?:password|passwd|pwd)[=:]\s*['"]?([^'"\s]+)['"]?/gi, replacement: 'password=***MASKED***' },
  { pattern: /Bearer\s+([a-zA-Z0-9._-]+)/gi, replacement: 'Bearer ***MASKED***' },
  { pattern: /AKIA[0-9A-Z]{16}/g, replacement: 'AKIA***MASKED***' },
];

const maskSensitiveData = (message: string) => {
  return sensitivePatterns.reduce(
    (msg, { pattern, replacement }) => msg.replace(pattern, replacement),
    message
  );
};
```

#### ë¹„ë°€í‚¤ ìŠ¤ìºë‹ ë„êµ¬ ë¹„êµ

| ë„êµ¬ | íŠ¹ì§• | ë¼ì´ì„ ìŠ¤ |
|------|------|----------|
| **Gitleaks** | ë¹ ë¥¸ ì†ë„, 800+ ê·œì¹™, CI/CD ì¹œí™”ì  | MIT |
| **TruffleHog v3** | 700+ íƒì§€ê¸°, API ê²€ì¦ ê¸°ëŠ¥ | AGPL-3.0 |
| **detect-secrets** | ë‚®ì€ ì˜¤íƒë¥ , ë² ì´ìŠ¤ë¼ì¸ ë°©ì‹ | Apache-2.0 |
| **GitHub Secret Scanning** | 200+ íŒŒíŠ¸ë„ˆ íŒ¨í„´, ë¬´ë£Œ(ê³µê°œ repo) | Proprietary |

---

### 2.4 í”Œë«í¼ë³„ ê´€ë¦¬

#### Vercel í™˜ê²½ë³€ìˆ˜ ì„¤ì •

Vercelì€ **Production**, **Preview**, **Development** ì„¸ ê°€ì§€ í™˜ê²½ì„ ì§€ì›í•©ë‹ˆë‹¤.

```bash
# Vercel CLI ì‚¬ìš©
vercel env add DATABASE_URL production     # í”„ë¡œë•ì…˜ í™˜ê²½ì— ì¶”ê°€
vercel env add DATABASE_URL preview        # í”„ë¦¬ë·° í™˜ê²½ì— ì¶”ê°€
vercel env add API_SECRET --sensitive      # ë¯¼ê° ë³€ìˆ˜ë¡œ í‘œì‹œ (ëŒ€ì‹œë³´ë“œì—ì„œ ë§ˆìŠ¤í‚¹)

# ë¡œì»¬ ê°œë°œìš© .env íŒŒì¼ ìƒì„±
vercel env pull                            # â†’ .env.local ìƒì„±
vercel env pull --environment production   # í”„ë¡œë•ì…˜ í™˜ê²½ë³€ìˆ˜ ë‹¤ìš´ë¡œë“œ
```

#### GitHub Actions Secrets

```yaml
# .github/workflows/deploy.yml
name: Deploy to Vercel
on:
  push:
    branches: [main, develop]

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  deploy-production:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: production  # í™˜ê²½ë³„ ì‹œí¬ë¦¿ ì‚¬ìš©
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Vercel CLI
        run: npm install -g vercel
      
      - name: Pull Vercel Environment
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
      
      - name: Build and Deploy
        run: |
          vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
          vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
        env:
          DATABASE_URL: ${{ secrets.PROD_DATABASE_URL }}
```

#### OIDC ê¸°ë°˜ ì¸ì¦ (ê¶Œì¥)

ì¥ê¸° í† í° ì €ì¥ ëŒ€ì‹  OIDCë¥¼ ì‚¬ìš©í•˜ë©´ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì‹œì—ë§Œ ë‹¨ê¸° í† í°ì´ ë°œê¸‰ë©ë‹ˆë‹¤.

```yaml
jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # OIDC í† í° ìš”ì²­ ê¶Œí•œ
      contents: read
    steps:
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::123456789:role/github-actions-role
          aws-region: us-east-1
```

---

### 2.5 í™˜ê²½ ë¶„ë¦¬ ì „ëµ

#### .env íŒŒì¼ ë¡œë”© ìš°ì„ ìˆœìœ„

Next.jsëŠ” í™˜ê²½ë³€ìˆ˜ë¥¼ ë‹¤ìŒ ìˆœì„œë¡œ ë¡œë”©í•©ë‹ˆë‹¤ (ë¨¼ì € ë°œê²¬ëœ ê°’ì´ ìš°ì„ ):

```
1. process.env (ì‹œìŠ¤í…œ í™˜ê²½ë³€ìˆ˜)           â† ìµœìš°ì„ 
2. .env.$(NODE_ENV).local                 (ì˜ˆ: .env.development.local)
3. .env.local                             (âš ï¸ test í™˜ê²½ì—ì„œëŠ” ë¡œë”© ì•ˆë¨)
4. .env.$(NODE_ENV)                       (ì˜ˆ: .env.production)
5. .env                                   â† ìµœí•˜ìœ„
```

#### ê¶Œì¥ íŒŒì¼ êµ¬ì¡°

```
my-next-app/
â”œâ”€â”€ .env                      # ëª¨ë“  í™˜ê²½ ê³µí†µ ê¸°ë³¸ê°’ (Git ì»¤ë°‹ O)
â”œâ”€â”€ .env.local                # ë¡œì»¬ ê°œë°œ ì˜¤ë²„ë¼ì´ë“œ (Git ì»¤ë°‹ X)
â”œâ”€â”€ .env.development          # ê°œë°œ í™˜ê²½ ê¸°ë³¸ê°’ (Git ì»¤ë°‹ O)
â”œâ”€â”€ .env.production           # í”„ë¡œë•ì…˜ í™˜ê²½ ê¸°ë³¸ê°’ (Git ì»¤ë°‹ O)
â”œâ”€â”€ .env.example              # í…œí”Œë¦¿ íŒŒì¼ (Git ì»¤ë°‹ í•„ìˆ˜)
â””â”€â”€ .gitignore
```

#### ìŠ¤í…Œì´ì§• í™˜ê²½ êµ¬ì„± ë°©ë²•

Next.jsëŠ” ê¸°ë³¸ì ìœ¼ë¡œ `development`, `production`, `test`ë§Œ ì§€ì›í•˜ë¯€ë¡œ, ìŠ¤í…Œì´ì§•ì€ ë‹¤ìŒ ë°©ì‹ìœ¼ë¡œ êµ¬ì„±í•©ë‹ˆë‹¤:

```json
// package.json
{
  "scripts": {
    "build:staging": "cp .env.staging .env.local && next build",
    "build:prod": "cp .env.prod .env.local && next build"
  }
}
```

#### íŒ€ í˜‘ì—… ì‹œ í™˜ê²½ë³€ìˆ˜ ê³µìœ  ë„êµ¬

| ë„êµ¬ | ë³´ì•ˆì„± | í¸ì˜ì„± | ë¹„ìš© |
|------|--------|--------|------|
| **Doppler** | â­â­â­â­â­ | â­â­â­â­â­ | $7/user/ì›”~ |
| **1Password Environments** | â­â­â­â­ | â­â­â­â­ | $7.99/user/ì›” |
| **Infisical** (ì˜¤í”ˆì†ŒìŠ¤) | â­â­â­â­ | â­â­â­â­ | ë¬´ë£Œ (ì…€í”„í˜¸ìŠ¤íŒ…) |
| **Vercel í™˜ê²½ë³€ìˆ˜** | â­â­â­â­ | â­â­â­â­ | í”Œëœ í¬í•¨ |

```bash
# Doppler ì‚¬ìš© ì˜ˆì‹œ
doppler login
doppler setup
doppler run -- npm run dev  # í™˜ê²½ë³€ìˆ˜ ìë™ ì£¼ì…
```

---

## 3. êµ¬í˜„ ì‹œ í•„ìˆ˜ ì‚¬í•­

### í™˜ê²½ë³€ìˆ˜ ë³´ì•ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸

**ì„¤ì • ë‹¨ê³„**
- [ ] `NEXT_PUBLIC_` ì ‘ë‘ì‚¬ëŠ” ê³µê°œ ê°€ëŠ¥í•œ ê°’ì—ë§Œ ì‚¬ìš©
- [ ] API í‚¤, DB ë¹„ë°€ë²ˆí˜¸ ë“± ë¯¼ê° ì •ë³´ëŠ” ì„œë²„ ì „ìš© í™˜ê²½ë³€ìˆ˜ë¡œ ì„¤ì •
- [ ] `.env.local`, `.env*.local` íŒŒì¼ì„ `.gitignore`ì— ì¶”ê°€
- [ ] `.env.example` í…œí”Œë¦¿ íŒŒì¼ ìƒì„± ë° Git ì»¤ë°‹

**ê²€ì¦ ë‹¨ê³„**
- [ ] t3-env ë˜ëŠ” Zodë¡œ í™˜ê²½ë³€ìˆ˜ ìŠ¤í‚¤ë§ˆ ê²€ì¦ êµ¬í˜„
- [ ] `next.config.ts`ì—ì„œ env íŒŒì¼ importí•˜ì—¬ ë¹Œë“œ íƒ€ì„ ê²€ì¦ í™œì„±í™”
- [ ] ê²€ì¦ ì‹¤íŒ¨ ì‹œ ëª…í™•í•œ ì—ëŸ¬ ë©”ì‹œì§€ ì¶œë ¥ ì„¤ì •

**ë³´ì•ˆ ë„êµ¬ ì ìš©**
- [ ] Husky + Gitleaksë¡œ pre-commit hook ì„¤ì •
- [ ] GitHub Secret Scanning ë° Push Protection í™œì„±í™”
- [ ] CI/CD íŒŒì´í”„ë¼ì¸ì— ë¹„ë°€í‚¤ ìŠ¤ìº” ë‹¨ê³„ ì¶”ê°€

**í”Œë«í¼ ì„¤ì •**
- [ ] Vercel í™˜ê²½ë³„(Production/Preview/Development) ë³€ìˆ˜ ë¶„ë¦¬
- [ ] GitHub Actionsì—ì„œ Environment Secrets ì‚¬ìš©
- [ ] ë¯¼ê° ë³€ìˆ˜ì— `--sensitive` í”Œë˜ê·¸ ì ìš© (Vercel)

**ëŸ°íƒ€ì„ ë³´ì•ˆ**
- [ ] ì„œë²„ ì „ìš© ì½”ë“œì— `import 'server-only'` ì¶”ê°€
- [ ] ë¡œê·¸/ì—ëŸ¬ ë©”ì‹œì§€ì—ì„œ ë¯¼ê° ì •ë³´ ë§ˆìŠ¤í‚¹ ì ìš©
- [ ] ë¹Œë“œ í›„ í´ë¼ì´ì–¸íŠ¸ ë²ˆë“¤ì—ì„œ ë¯¼ê° ì •ë³´ ë…¸ì¶œ ì—¬ë¶€ í™•ì¸

---

## 4. ì½”ë“œ ì˜ˆì‹œ

### í™˜ê²½ë³€ìˆ˜ ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸ (t3-env í™œìš©)

```typescript
// src/env.ts
import { createEnv } from "@t3-oss/env-nextjs";
import { z } from "zod";

export const env = createEnv({
  /*
   * ì„œë²„ ì‚¬ì´ë“œ í™˜ê²½ë³€ìˆ˜
   * í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì ‘ê·¼ ì‹œ ëŸ°íƒ€ì„ ì—ëŸ¬ ë°œìƒ
   */
  server: {
    // ë°ì´í„°ë² ì´ìŠ¤
    DATABASE_URL: z.string().url().describe("PostgreSQL ì—°ê²° ë¬¸ìì—´"),
    
    // ì¸ì¦
    AUTH_SECRET: z.string().min(32).describe("NextAuth ì‹œí¬ë¦¿ (openssl rand -base64 32)"),
    
    // ì™¸ë¶€ API
    OPENAI_API_KEY: z.string().startsWith("sk-").describe("OpenAI API í‚¤"),
    STRIPE_SECRET_KEY: z.string().startsWith("sk_").describe("Stripe ì‹œí¬ë¦¿ í‚¤"),
    
    // í™˜ê²½ ì„¤ì •
    NODE_ENV: z.enum(["development", "test", "production"]).default("development"),
  },

  /*
   * í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ í™˜ê²½ë³€ìˆ˜
   * NEXT_PUBLIC_ ì ‘ë‘ì‚¬ í•„ìˆ˜, ë¸Œë¼ìš°ì €ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥
   */
  client: {
    NEXT_PUBLIC_APP_URL: z.string().url().describe("ì• í”Œë¦¬ì¼€ì´ì…˜ URL"),
    NEXT_PUBLIC_SUPABASE_URL: z.string().url().describe("Supabase í”„ë¡œì íŠ¸ URL"),
    NEXT_PUBLIC_SUPABASE_ANON_KEY: z.string().min(1).describe("Supabase ìµëª… í‚¤"),
    NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: z.string().startsWith("pk_").describe("Stripe ê³µê°œ í‚¤"),
    NEXT_PUBLIC_GA_ID: z.string().optional().describe("Google Analytics ID"),
  },

  /*
   * ëŸ°íƒ€ì„ í™˜ê²½ë³€ìˆ˜ ë§¤í•‘
   * ëª¨ë“  ë³€ìˆ˜ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ë§¤í•‘í•´ì•¼ í•¨
   */
  runtimeEnv: {
    // ì„œë²„
    DATABASE_URL: process.env.DATABASE_URL,
    AUTH_SECRET: process.env.AUTH_SECRET,
    OPENAI_API_KEY: process.env.OPENAI_API_KEY,
    STRIPE_SECRET_KEY: process.env.STRIPE_SECRET_KEY,
    NODE_ENV: process.env.NODE_ENV,
    // í´ë¼ì´ì–¸íŠ¸
    NEXT_PUBLIC_APP_URL: process.env.NEXT_PUBLIC_APP_URL,
    NEXT_PUBLIC_SUPABASE_URL: process.env.NEXT_PUBLIC_SUPABASE_URL,
    NEXT_PUBLIC_SUPABASE_ANON_KEY: process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,
    NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY,
    NEXT_PUBLIC_GA_ID: process.env.NEXT_PUBLIC_GA_ID,
  },

  // ë¹ˆ ë¬¸ìì—´ì„ undefinedë¡œ ì²˜ë¦¬ (Vercel í™˜ê²½ë³€ìˆ˜ í˜¸í™˜)
  emptyStringAsUndefined: true,

  // Docker ë¹Œë“œ ì‹œ ê²€ì¦ ê±´ë„ˆë›°ê¸°
  skipValidation: 
    process.env.SKIP_ENV_VALIDATION === "true" ||
    process.env.npm_lifecycle_event === "lint",

  // ê²€ì¦ ì‹¤íŒ¨ ì‹œ ì»¤ìŠ¤í…€ ì—ëŸ¬
  onValidationError: (issues) => {
    console.error("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
    console.error("â”‚ âš ï¸  í™˜ê²½ë³€ìˆ˜ ê²€ì¦ ì‹¤íŒ¨");
    console.error("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
    issues.forEach((issue) => {
      const path = issue.path?.map((p) => (typeof p === "object" && "key" in p ? p.key : p)).join(".") || "unknown";
      console.error(`â”‚  âŒ ${path}: ${issue.message}`);
    });
    console.error("â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
    console.error("â”‚ .env.example íŒŒì¼ì„ ì°¸ê³ í•˜ì—¬ ì„¤ì •í•˜ì„¸ìš”");
    console.error("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
    throw new Error(`í™˜ê²½ë³€ìˆ˜ ê²€ì¦ ì‹¤íŒ¨: ${issues.length}ê°œ ì˜¤ë¥˜`);
  },

  // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì„œë²„ ë³€ìˆ˜ ì ‘ê·¼ ì‹œ
  onInvalidAccess: (variable) => {
    throw new Error(
      `ğŸš« ë³´ì•ˆ ìœ„ë°˜: í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì„œë²„ ì „ìš© í™˜ê²½ë³€ìˆ˜ "${variable}" ì ‘ê·¼ ì‹œë„.\n` +
      `Server Components, API Routes, Server Actionsì—ì„œë§Œ ì‚¬ìš©í•˜ì„¸ìš”.`
    );
  },
});

// íƒ€ì… ì¶”ë¡ ìš© export
export type Env = typeof env;
```

### next.config.ts ì„¤ì •

```typescript
// next.config.ts
import type { NextConfig } from "next";

// ë¹Œë“œ ì‹œ í™˜ê²½ë³€ìˆ˜ ê²€ì¦ ì‹¤í–‰
import "./src/env";

const nextConfig: NextConfig = {
  // í”„ë¡œë•ì…˜ì—ì„œ ì†ŒìŠ¤ë§µ ë¹„í™œì„±í™” (ë³´ì•ˆ)
  productionBrowserSourceMaps: false,
  
  // standalone ì¶œë ¥ (Docker ë°°í¬ìš©)
  output: "standalone",
  
  // t3-env íŒ¨í‚¤ì§€ íŠ¸ëœìŠ¤íŒŒì¼
  transpilePackages: ["@t3-oss/env-nextjs", "@t3-oss/env-core"],
};

export default nextConfig;
```

### .env.example í…œí”Œë¦¿

```bash
# .env.example
# ============================================
# í™˜ê²½ë³€ìˆ˜ ì„¤ì • ê°€ì´ë“œ
# ì´ íŒŒì¼ì„ .env.localë¡œ ë³µì‚¬í•œ í›„ ì‹¤ì œ ê°’ì„ ì…ë ¥í•˜ì„¸ìš”
# cp .env.example .env.local
# ============================================

# ---- ë°ì´í„°ë² ì´ìŠ¤ ----
DATABASE_URL="postgresql://user:password@localhost:5432/dbname"

# ---- ì¸ì¦ ----
# ìƒì„± ë°©ë²•: openssl rand -base64 32
AUTH_SECRET="your-secret-key-at-least-32-characters"

# ---- ì™¸ë¶€ API í‚¤ ----
OPENAI_API_KEY="sk-your-openai-api-key"
STRIPE_SECRET_KEY="sk_test_your-stripe-secret-key"

# ---- í´ë¼ì´ì–¸íŠ¸ ë…¸ì¶œ ë³€ìˆ˜ (NEXT_PUBLIC_) ----
NEXT_PUBLIC_APP_URL="http://localhost:3000"
NEXT_PUBLIC_SUPABASE_URL="https://your-project.supabase.co"
NEXT_PUBLIC_SUPABASE_ANON_KEY="your-supabase-anon-key"
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY="pk_test_your-stripe-publishable-key"

# ---- ì„ íƒì  ë³€ìˆ˜ ----
# NEXT_PUBLIC_GA_ID="G-XXXXXXXXXX"
# SKIP_ENV_VALIDATION="false"
```

### GitHub Actions ë¹„ë°€í‚¤ ìŠ¤ìº” ì›Œí¬í”Œë¡œìš°

```yaml
# .github/workflows/security-scan.yml
name: Security Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  gitleaks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Gitleaks Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

---

## 5. ì°¸ê³  ìë£Œ

- Next.js ê³µì‹ ë¬¸ì„œ - Environment Variables: https://nextjs.org/docs/pages/guides/environment-variables
- Next.js ë³´ì•ˆ ê°€ì´ë“œ - Data Security: https://nextjs.org/docs/app/guides/data-security
- t3-env ê³µì‹ ë¬¸ì„œ: https://env.t3.gg/docs/nextjs
- Vercel í™˜ê²½ë³€ìˆ˜ ë¬¸ì„œ: https://vercel.com/docs/environment-variables
- GitHub Actions Secrets: https://docs.github.com/en/actions/concepts/security/secrets
- OWASP Secrets Management Cheat Sheet: https://cheatsheetseries.owasp.org/cheatsheets/Secrets_Management_Cheat_Sheet.html
- Gitleaks GitHub: https://github.com/gitleaks/gitleaks
- Doppler ê³µì‹ ë¬¸ì„œ: https://docs.doppler.com