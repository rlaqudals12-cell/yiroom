# ADR-059: Contextual Retrieval 적용 보류

## 상태

`deferred`

## 날짜

2026-01-31

## 맥락 (Context)

Anthropic이 발표한 **Contextual Retrieval** 기법을 Coach RAG 모듈에 적용할지 검토했습니다.

### 조사 배경

- Claude의 공식 RAG 지원 (Projects RAG - 유료 플랜)
- Anthropic의 Contextual Retrieval 논문 및 가이드
- 현재 Coach RAG 구현 분석 (workout-rag, nutrition-rag)

### Contextual Retrieval 요약

기존 RAG의 청크가 컨텍스트를 잃는 문제를 해결:

```
기존: "회사 수익이 지난 분기 대비 3% 증가했다"
     → 어느 회사? 어느 분기? 맥락 손실

Contextual: "ACME사 Q2 2023 공시, 전 분기 수익 $314M"
          + "회사 수익이 지난 분기 대비 3% 증가했다"
```

**Anthropic 벤치마크 효과**:

| 방식                  | 검색 실패율 감소 |
| --------------------- | ---------------- |
| Contextual Embeddings | 35%              |
| + BM25 하이브리드     | 49%              |
| + Reranking           | 67%              |

### 현재 이룸 Coach RAG 현황

| 항목        | 현재 상태                         |
| ----------- | --------------------------------- |
| 검색 방식   | 키워드 패턴 매칭                  |
| 임베딩      | 없음                              |
| 캐싱        | 미비                              |
| 데이터 소스 | 운동 60개 (인메모리), 레시피 (DB) |

## 결정 (Decision)

**보류** - P0 (요구사항 의심) 원칙 적용 결과, 현재는 적용하지 않음.

### P0 "왜?" 3회 질문

1. **현재 RAG가 문제인가?** → 아니오. 정상 작동 중, 장애/불만 보고 없음
2. **검색 실패율 데이터가 있는가?** → 없음. 측정 체계 부재
3. **더 중요한 작업이 있는가?** → 예. 테스트 커버리지 65%→85% 작업 미완료

## 대안 (Alternatives Considered)

| 대안                                  | 비용       | 시간    | 효과             | 결정         |
| ------------------------------------- | ---------- | ------- | ---------------- | ------------ |
| 전면 도입 (Embedding + BM25 + Rerank) | $90-170/월 | 6-8주   | 검색 67% 개선    | ❌ 과투자    |
| 점진적 도입 (Phase 1-4)               | $0→$80/월  | 10-12주 | 단계별 검증      | ❌ 시간 소요 |
| Phase 1만 (BM25)                      | $0         | 3-4시간 | 검색 ~20% 개선   | ⏸️ 보류      |
| **보류**                              | $0         | 0       | 없음 (현상 유지) | ✅ 선택      |

### 보류 이유

- **문제가 없다**: 현재 RAG가 정상 작동 중
- **측정 없음**: 개선 효과를 증명할 데이터가 없음
- **더 급한 작업**: 테스트 커버리지, 보안 테스트가 우선
- **비용 대비 효과 불명**: 무료($0)라도 개발 시간은 비용

## 결과 (Consequences)

### 긍정적 결과

- 불필요한 복잡도 추가 방지
- 테스트 커버리지 등 핵심 작업에 집중 가능
- 추측 기반 최적화 회피

### 부정적 결과

- 검색 품질 개선 기회 보류
- 신기술 적용 지연

### 리스크

- 사용자 증가 시 검색 품질 이슈 발생 가능 → **재검토 트리거**로 대응

## 재검토 트리거

다음 중 하나라도 발생 시 재검토:

| 트리거        | 조건                                           |
| ------------- | ---------------------------------------------- |
| 사용자 피드백 | "운동 추천이 안 맞아요" 등 검색 관련 불만 3건+ |
| 검색 실패율   | 측정 후 20% 이상 확인                          |
| MAU           | 1만+ 도달 후 코치 품질 이슈                    |
| 코치 마케팅   | 핵심 기능으로 홍보 계획 수립 시                |

## 보류 중 준비 사항

재검토 시점에 빠른 적용을 위해:

1. **검색 품질 로깅 추가** (선택적)
   - 코치 세션별 사용자 만족도
   - 검색 결과 클릭률

2. **pg_trgm 확장 활성화** (무비용)
   - Supabase Dashboard에서 활성화만 해두기
   - 실제 사용은 재검토 시점에

## 관련 문서

### 원리 문서

- (향후 작성 시) docs/principles/rag-retrieval.md

### 관련 ADR

- [ADR-027: Coach AI 스트리밍](./ADR-027-coach-ai-streaming.md) - 코치 아키텍처
- [ADR-003: AI 모델 선택](./ADR-003-ai-model-selection.md) - Gemini 선택

### 외부 참고

- [Anthropic - Contextual Retrieval](https://www.anthropic.com/news/contextual-retrieval)
- [Claude Projects RAG](https://support.anthropic.com/en/articles/9942194-retrieval-augmented-generation-rag-for-projects)

---

**Author**: Claude Code
**Reviewed by**: -
