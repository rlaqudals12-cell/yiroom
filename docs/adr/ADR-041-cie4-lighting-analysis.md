# ADR-041: CIE-4 조명 분석 (Lighting Analysis)

## 상태

`accepted`

## 날짜

2026-01-23

## 0. 궁극의 형태 (P1)

### 이상적 최종 상태

"모든 조명 환경에서 정확한 조명 품질 평가와 실시간 피드백을 통해 사용자가 최적의 촬영 환경을 갖추도록 안내하는 시스템"

- **정확한 CCT 추정**: McCamy 공식 기반 ±100K 오차 이내 색온도 측정
- **실시간 6-Zone 분석**: 얼굴 6개 영역의 밝기 균일성 평가
- **그림자 자동 감지**: 좌우 비대칭 5% 이상 시 자동 경고
- **조명 가이드 UI**: 실시간 피드백으로 재촬영 최소화

### 물리적 한계

| 항목 | 한계 |
|------|------|
| CCT 정확도 | McCamy 공식은 4000-25000K 범위에서만 유효 |
| 균일성 분석 | 3D 조명(깊이)은 2D 이미지로 완전 추정 불가 |
| 실시간 처리 | 50ms 이내 처리로 정밀도 trade-off |
| 혼합 조명 | 복수 광원(창가+형광등)의 개별 분리 어려움 |

### 100점 기준

| 지표 | 100점 기준 | 현재 | 비고 |
|------|-----------|------|------|
| CCT 추정 정확도 | ±100K | - | McCamy + xy 색도 |
| 균일성 점수 | σ < 10 (100점) | - | 6-Zone 분산 |
| 그림자 감지율 | 95% | - | L/R 비대칭 감지 |
| 처리 시간 | < 50ms | - | 실시간 가이드용 |
| 재촬영 유도 성공률 | 80% | - | 가이드 후 재촬영 |

### 현재 목표: 85%

### 의도적 제외

| 제외 항목 | 이유 | 재검토 시점 |
|----------|------|------------|
| 딥러닝 기반 조명 추정 | 모델 사이즈 + 추론 시간 (HIGH_COMPLEXITY) | Edge ML 최적화 가능 시 |
| 3D 조명 재구성 | Depth 센서 필요 (HARDWARE_DEPENDENCY) | 모바일 LiDAR 보급 시 |
| 조명 자동 보정 | CIE-3에서 처리, 역할 분리 (ALT_SUFFICIENT) | - |
| 스튜디오급 측광기 정확도 | 전문 장비 수준 불필요 (NOT_NEEDED) | 전문가 모드 추가 시 |

## 맥락 (Context)

CIE-3에서 화이트밸런스 보정을 수행한 후, 이미지의 조명 품질을 평가하여 AI 분석의 신뢰도를 조절해야 합니다. 사용자에게 실시간 조명 가이드를 제공하여 재촬영을 최소화해야 합니다.

### 현재 문제

1. **조명 품질 평가 부재**:
   - CIE-3에서 보정은 수행하지만 품질 평가 없음
   - 극단적 조명(백열등, 흐린 날)에서 보정 한계 존재
   - 사용자가 조명 문제를 인지하지 못함

2. **그림자로 인한 분석 오류**:
   - 측면 조명으로 인한 얼굴 좌우 비대칭
   - S-1 피부 상태 분석에서 음영을 색소침착으로 오인
   - PC-1 퍼스널컬러에서 부분적 색상 왜곡

3. **조명 불균일**:
   - 이마, 볼, 턱 간 밝기 편차
   - 부분 과노출/과소노출
   - 혼합 조명 환경 (창가 + 형광등)

### 요구사항

| 요구사항 | 우선순위 | 근거 |
|---------|---------|------|
| CCT 추정 및 품질 판정 | P0 | CIE-3 보정 품질 평가 |
| 6-Zone 균일성 분석 | P0 | 정확한 피부 분석 |
| 좌우 그림자 감지 | P0 | 분석 오류 방지 |
| 신뢰도 계수 산출 | P0 | CIE 파이프라인 통합 |
| 조명 가이드 UI | P1 | 사용자 재촬영 유도 |
| 처리 시간 < 50ms | P1 | 실시간 피드백 |

## 결정 (Decision)

**McCamy CCT + 6-Zone Uniformity + L/R Shadow Detection**을 구현합니다.

### 아키텍처

```
┌─────────────────────────────────────────────────────────────────┐
│                    CIE-4 조명 분석 파이프라인                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  CIE-3 보정 이미지 + CIE-2 얼굴 랜드마크                         │
│       │                                                         │
│       ▼                                                         │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Stage 1: CCT 추정                                        │   │
│  │   ├── sRGB → Linear RGB → XYZ                           │   │
│  │   ├── XYZ → xy 색도 좌표                                 │   │
│  │   ├── McCamy 공식: n = (x-0.3320)/(0.1858-y)           │   │
│  │   │   CCT = 449n³ + 3525n² + 6823n + 5520               │   │
│  │   └── 품질 판정: optimal/good/acceptable/poor/reject    │   │
│  └─────────────────────────────────────────────────────────┘   │
│       │                                                         │
│       ▼                                                         │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Stage 2: 6-Zone 균일성 분석                              │   │
│  │   ├── 랜드마크 기반 영역 분할                            │   │
│  │   │   ┌─────┬─────┐                                     │   │
│  │   │   │ L-F │ R-F │  Forehead                           │   │
│  │   │   ├─────┼─────┤                                     │   │
│  │   │   │ L-C │ R-C │  Cheek                              │   │
│  │   │   ├─────┼─────┤                                     │   │
│  │   │   │ L-J │ R-J │  Jaw                                │   │
│  │   │   └─────┴─────┘                                     │   │
│  │   ├── 각 Zone Y채널 평균: Y = 0.299R + 0.587G + 0.114B  │   │
│  │   ├── 분산 계산: σ² = Σ(Y_zone - μ)² / 6               │   │
│  │   └── 균일성 점수: max(0, 100 - σ × 2.0)               │   │
│  └─────────────────────────────────────────────────────────┘   │
│       │                                                         │
│       ▼                                                         │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Stage 3: 그림자 감지                                     │   │
│  │   ├── 좌측 평균: (L-F + L-C + L-J) / 3                  │   │
│  │   ├── 우측 평균: (R-F + R-C + R-J) / 3                  │   │
│  │   ├── 비대칭: ΔLR = |Left - Right| / Total × 100       │   │
│  │   ├── 심각도: none(<5%) / mild / moderate / severe(>20%)│   │
│  │   └── 방향: left / right / balanced                     │   │
│  └─────────────────────────────────────────────────────────┘   │
│       │                                                         │
│       ▼                                                         │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Stage 4: 종합 평가 및 신뢰도 산출                        │   │
│  │   ├── overallScore = CCT×0.4 + Uniform×0.35 + Shadow×0.25│  │
│  │   ├── confidence = 가중 평균 (CIE 파이프라인 전파용)     │   │
│  │   ├── primaryIssue 식별                                 │   │
│  │   └── feedback 메시지 생성                              │   │
│  └─────────────────────────────────────────────────────────┘   │
│       │                                                         │
│       ▼                                                         │
│  LightingAnalysisOutput + 조명 가이드 UI 데이터                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### CCT 품질 기준

| 품질 등급 | CCT 범위 (K) | 점수 | 조치 |
|-----------|-------------|------|------|
| **optimal** | 5000-6500 | 100 | 보정 생략 가능 |
| good | 4500-5000 또는 6500-7000 | 85 | 경미한 보정 |
| acceptable | 4000-4500 또는 7000-8000 | 70 | 보정 필수 |
| poor | 3000-4000 또는 8000-10000 | 40 | 재촬영 권장 |
| **reject** | <3000 또는 >10000 | 0 | 재촬영 필수 |

### 균일성/그림자 판정

| 균일성 점수 | 분산 (σ) | 판정 |
|------------|---------|------|
| 85-100 | < 7.5 | 최적 |
| 70-84 | 7.5-15 | 양호 |
| 50-69 | 15-25 | 수용 |
| < 50 | > 25 | 부적합 |

| 비대칭 (ΔLR %) | 심각도 | 판정 |
|---------------|--------|------|
| < 5 | none | 정상 |
| 5-10 | mild | 경미 |
| 10-20 | moderate | 중간 |
| > 20 | severe | 심각 |

## 대안 (Alternatives Considered)

| 대안 | 장점 | 단점 | 제외 사유 |
|------|------|------|----------|
| **히스토그램 분석** | 구현 단순 | 공간 정보 손실 | `ACCURACY` - 그림자 위치 모름 |
| **딥러닝 조명 추정** | 높은 정확도 | 모델 크기, 추론 시간 | `PERFORMANCE` - 실시간 불가 |
| **카메라 EXIF CCT** | 정확 | EXIF 없는 이미지 다수 | `COMPATIBILITY` - 범용성 부족 |
| **전체 이미지 4분할** | 랜드마크 불필요 | 얼굴 영역 불정확 | `ACCURACY` - 폴백으로만 사용 |
| **McCamy + 6-Zone** ✅ | 정확도/성능 균형 | 랜드마크 의존 | **채택** |

### CCT 추정 방법 비교

| 방법 | 정확도 | 복잡도 | 선택 |
|------|--------|--------|------|
| McCamy 공식 | ±50K (5000-7000K) | 낮음 | ✅ 채택 |
| Robertson 반복법 | ±25K | 중간 | 향후 개선 |
| Planckian locus 투영 | ±10K | 높음 | 과도 |

## 결과 (Consequences)

### 긍정적 결과

- **분석 정확도 향상**: 조명 품질 기반 신뢰도 조절
- **사용자 가이드**: 실시간 피드백으로 재촬영 최소화
- **파이프라인 통합**: CIE-1~CIE-3와 confidence 연계
- **문제 진단**: primaryIssue로 구체적 개선점 제시

### 부정적 결과

- **CIE-2 의존성**: 랜드마크 없이 정확도 저하 (4분할 폴백)
- **혼합 조명 한계**: 단일 CCT로 복합 광원 표현 불가
- **처리 시간**: ~30-50ms 추가

### 리스크

- **McCamy 공식 한계**: CCT < 3000K 또는 > 10000K에서 부정확
- **피부색과 유사한 배경**: Zone 추출 시 오염 가능
- **과노출/과소노출**: Y채널 클리핑으로 분석 왜곡

### 완화 전략

- **CCT 범위 검증**: reject 범위에서 사용자 경고
- **피부 마스크 교차 검증**: CIE-3 피부 영역과 비교
- **클리핑 감지**: Y < 10 또는 Y > 245 비율 체크

## 구현 가이드

### 파일 구조

```
lib/image-engine/cie-4/
├── index.ts                    # 공개 API
├── types.ts                    # CIE-4 타입
├── internal/
│   ├── cct-estimator.ts        # McCamy CCT
│   ├── zone-extractor.ts       # 6-Zone 추출
│   ├── brightness-calculator.ts # Y채널 계산
│   ├── uniformity-analyzer.ts  # 균일성 분석
│   ├── shadow-detector.ts      # 그림자 감지
│   └── feedback-generator.ts   # 피드백 생성
└── __tests__/
    └── lighting-analysis.test.ts
```

### 공개 API

```typescript
// lib/image-engine/cie-4/index.ts
export { analyzeLighting } from './internal/lighting-analyzer';
export { estimateCCT } from './internal/cct-estimator';
export type {
  CIE4Input,
  CIE4Output,
  CCTEstimationResult,
  UniformityResult,
  ShadowDetectionResult,
} from './types';
```

### 핵심 타입

```typescript
interface CIE4Output {
  cct: CCTEstimationResult;
  uniformity: UniformityResult;
  shadow: ShadowDetectionResult;
  overallScore: number;         // 0-100
  isAcceptable: boolean;
  confidence: number;           // 0-1 (파이프라인 전파용)
  primaryIssue: string | null;
  feedback: string;
  processingTime: number;       // ms
}
```

### 신뢰도 전파

```
최종 분석 신뢰도 = CIE-1 × CIE-2 × CIE-3 × CIE-4 × 분석모듈

예시 (그림자가 있는 경우):
CIE-1 (품질): 0.95
CIE-2 (랜드마크): 0.90
CIE-3 (AWB): 0.85
CIE-4 (조명): 0.65  ← 그림자로 인해 낮음
PC-1 (퍼스널컬러): 0.88

최종 = 0.95 × 0.90 × 0.85 × 0.65 × 0.88 = 0.42 (42%)
→ "분석 결과를 참고용으로 확인해 주세요" 표시
```

## 테스트 시나리오

| 시나리오 | 입력 | 예상 결과 |
|---------|------|----------|
| 정상 자연광 | CCT ~6000K, 균일 | overallScore > 85, confidence > 0.9 |
| 백열등 | CCT ~2700K | quality='poor', 재촬영 권장 |
| 측면 조명 | ΔLR > 15% | shadow.severity='moderate' |
| 얼굴 클로즈업 | 랜드마크 없음 | 4분할 폴백, confidence 감소 |
| 혼합 조명 | 창가+형광등 | uniformity < 70, 경고 |

## 관련 문서

### 원리 문서 (과학적 기초)
- [원리: 이미지 처리](../principles/image-processing.md) - 색온도, CCT 이론
- [원리: 색채학](../principles/color-science.md) - CIE 색공간, Planckian locus

### 관련 ADR
- [ADR-001: Core Image Engine](./ADR-001-core-image-engine.md) - CIE 파이프라인 아키텍처
- [ADR-040: CIE-3 조명 보정](./ADR-040-cie3-lighting-correction.md) - 선행 보정 단계
- [ADR-033: 얼굴 감지 라이브러리](./ADR-033-face-detection-library.md) - 랜드마크 소스

### 관련 스펙
- [SDD-CIE-4-LIGHTING-ANALYSIS](../specs/SDD-CIE-4-LIGHTING-ANALYSIS.md) - 상세 구현 스펙

## 구현 스펙

이 ADR을 구현하는 스펙 문서:

| 스펙 | 상태 | 설명 |
|------|------|------|
| [SDD-CIE-4-LIGHTING-ANALYSIS](../specs/SDD-CIE-4-LIGHTING-ANALYSIS.md) | ✅ 작성 완료 | 조명 분석 상세 |

---

**Author**: Claude Code
**Reviewed by**: -
