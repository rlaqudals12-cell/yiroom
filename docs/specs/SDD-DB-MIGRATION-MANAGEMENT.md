# Task: DB ë§ˆì´ê·¸ë ˆì´ì…˜ ê´€ë¦¬ ì²´ê³„ (SDD-DB-MIGRATION-MANAGEMENT)

**Phase**: L-2 (ì¶œì‹œ ì¤€ë¹„)
**ì‘ì„±ì¼**: 2026-01-08
**ìˆ˜ì •ì¼**: 2026-01-28
**ìš°ì„ ìˆœìœ„**: ì¤‘ê°„ (ë°°í¬ ì „ í•„ìˆ˜)
**ì˜ˆìƒ ë³µì¡ë„**: 35ì  (ë¬¸ì„œí™” + SQL ì •ë¦¬)

### ê´€ë ¨ ë¬¸ì„œ

#### ADR

- [ADR-008: Repository-Service ê³„ì¸µ](../adr/ADR-008-repository-service-layer.md) - ë°ì´í„° ì ‘ê·¼ íŒ¨í„´

#### ê·œì¹™

- [ê·œì¹™: DB ë§ˆì´ê·¸ë ˆì´ì…˜](../../.claude/rules/db-migration-rules.md) - ë§ˆì´ê·¸ë ˆì´ì…˜ ì›Œí¬í”Œë¡œìš°

---

## 0. ê¶ê·¹ì˜ í˜•íƒœ (P1)

### ì´ìƒì  ìµœì¢… ìƒíƒœ

"ëª¨ë“  ìŠ¤í‚¤ë§ˆ ë³€ê²½ì´ ë²„ì „ ê´€ë¦¬ë˜ê³ , í™˜ê²½ ê°„ ì™„ë²½íˆ ë™ê¸°í™”ë˜ë©°, ì•ˆì „í•œ ë¡¤ë°±ì´ ê°€ëŠ¥í•œ DB ë§ˆì´ê·¸ë ˆì´ì…˜ ì²´ê³„"

- ëª¨ë“  í…Œì´ë¸”ì´ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ë¡œ ê´€ë¦¬ë¨
- ë¡œì»¬/ìŠ¤í…Œì´ì§•/í”„ë¡œë•ì…˜ ìŠ¤í‚¤ë§ˆ 100% ì¼ì¹˜
- RLS ì •ì±…ì´ ì¼ê´€ë˜ê²Œ ì ìš©ë¨
- ë¡¤ë°± ìŠ¤í¬ë¦½íŠ¸ í•­ìƒ ì¡´ì¬

### ë¬¼ë¦¬ì  í•œê³„

| í•œê³„ | ì´ìœ  | ì™„í™” ì „ëµ |
|------|------|----------|
| ëŒ€ì‹œë³´ë“œ ì§ì ‘ ìˆ˜ì • | ê¸‰í•œ ìˆ˜ì • ì‹œ ìš°íšŒ | ì‚¬í›„ ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒì„± í•„ìˆ˜ |
| ë‹¤ìš´íƒ€ì„ | ëŒ€ê·œëª¨ ìŠ¤í‚¤ë§ˆ ë³€ê²½ | ì ì§„ì  ë§ˆì´ê·¸ë ˆì´ì…˜ |
| ë°ì´í„° ì†ì‹¤ | ì»¬ëŸ¼ ì‚­ì œ ì‹œ | ì†Œí”„íŠ¸ ì‚­ì œ í›„ 2ì£¼ ëŒ€ê¸° |

### 100ì  ê¸°ì¤€

| ì§€í‘œ | 100ì  ê¸°ì¤€ | í˜„ì¬ |
|------|-----------|------|
| ë§ˆì´ê·¸ë ˆì´ì…˜ ì»¤ë²„ë¦¬ì§€ | 100% í…Œì´ë¸” | 90% |
| í™˜ê²½ ê°„ ìŠ¤í‚¤ë§ˆ ì¼ì¹˜ | 100% | 95% |
| RLS ì •ì±… ì¼ê´€ì„± | 100% | 90% |
| ë¡¤ë°± ìŠ¤í¬ë¦½íŠ¸ ì¡´ì¬ | 100% | 70% |

### í˜„ì¬ ëª©í‘œ: 80%

**ì¢…í•© ë‹¬ì„±ë¥ **: **80%** (ê¸°ì´ˆ ì²´ê³„ í™•ë¦½)

| ê¸°ëŠ¥ | ë‹¬ì„±ë¥  | ìƒíƒœ |
|------|--------|------|
| ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ê´€ë¦¬ | 90% | âœ… 60ê°œ |
| ìŠ¤í‚¤ë§ˆ ë²„ì „ ì¶”ì  | 80% | âœ… |
| RLS ì •ì±… í†µí•© | 85% | âœ… |
| ê²€ì¦ ì ˆì°¨ | 75% | ğŸ“ |
| ë¡¤ë°± ì „ëµ | 70% | ğŸ“ |

### ì˜ë„ì  ì œì™¸

| ì œì™¸ í•­ëª© | ì´ìœ  | ì¬ê²€í†  ì‹œì  |
|----------|------|------------|
| ìë™ ìŠ¤í‚¤ë§ˆ ë™ê¸°í™” | ìˆ˜ë™ ê²€í†  í•„ìš” | ì•ˆì •í™” í›„ |
| Blue-Green ë°°í¬ | ì¸í”„ë¼ ë³µì¡ë„ | íŠ¸ë˜í”½ ì¦ê°€ ì‹œ |
| ìë™ ë¡¤ë°± | ë°ì´í„° ë¬´ê²°ì„± ìœ„í—˜ | í…ŒìŠ¤íŠ¸ ê°•í™” í›„ |

---

## 1. ê°œìš”

### 1.1 ëª©ì 

- ëˆ„ë½ëœ ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ìƒì„±
- Supabase ëŒ€ì‹œë³´ë“œì—ì„œ ì§ì ‘ ìƒì„±í•œ í…Œì´ë¸”ì˜ SQL ë¬¸ì„œí™”
- ë°°í¬ í™˜ê²½ ê°„ ìŠ¤í‚¤ë§ˆ ì¼ê´€ì„± ë³´ì¥

### 1.2 í˜„ì¬ ë¬¸ì œì 

| ë¬¸ì œ                          | ì˜í–¥                           | ìœ„í—˜ë„  |
| ----------------------------- | ------------------------------ | ------- |
| ì¼ë¶€ í…Œì´ë¸” ë§ˆì´ê·¸ë ˆì´ì…˜ ëˆ„ë½ | ìƒˆ í™˜ê²½ ë°°í¬ ì‹œ ìˆ˜ë™ ì‘ì—… í•„ìš” | ğŸ”´ ë†’ìŒ |
| ìŠ¤í‚¤ë§ˆ ë²„ì „ ì¶”ì  ë¶ˆê°€         | ë¡¤ë°±/ë””ë²„ê¹… ì–´ë ¤ì›€             | ğŸŸ¡ ì¤‘ê°„ |
| RLS ì •ì±… íŒŒí¸í™”               | ë³´ì•ˆ ì¼ê´€ì„± ì €í•˜               | ğŸ”´ ë†’ìŒ |

---

## 2. í˜„í™© ë¶„ì„

### 2.1 ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ í˜„í™© (60ê°œ)

```
supabase/migrations/
â”œâ”€â”€ 00000000000000_setup_schema.sql
â”œâ”€â”€ 00000000000001_setup_storage.sql
â”œâ”€â”€ 00000000000002_phase1_analysis_tables.sql
â”œâ”€â”€ 20251126~202601... (57ê°œ íŒŒì¼)
â””â”€â”€ 202601080600_user_agreements.sql (ìµœì‹ )
```

### 2.2 ëˆ„ë½ ì˜ì‹¬ í…Œì´ë¸”

| í…Œì´ë¸”                       | ìƒíƒœ         | ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼                         |
| ---------------------------- | ------------ | ----------------------------------------- |
| `users`                      | âš ï¸ í™•ì¸ í•„ìš” | ì—†ìŒ (Clerk ë™ê¸°í™”)                       |
| `personal_color_assessments` | âš ï¸ í™•ì¸ í•„ìš” | phase1_analysis_tables.sqlì— ìˆì„ ìˆ˜ ìˆìŒ |
| `skin_analyses`              | âœ… ìˆìŒ      | 202601080300_skin_analyses_extension.sql  |
| `body_analyses`              | âš ï¸ í™•ì¸ í•„ìš” | phase1_analysis_tables.sqlì— ìˆì„ ìˆ˜ ìˆìŒ |

---

## 3. ê²€ì¦ ì ˆì°¨

### 3.1 ë¡œì»¬ Supabaseì™€ í”„ë¡œë•ì…˜ ë¹„êµ

```bash
# 1. ë¡œì»¬ Supabase ì‹œì‘
npx supabase start

# 2. ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš©
npx supabase db reset

# 3. ìŠ¤í‚¤ë§ˆ ë¤í”„
npx supabase db dump -f local_schema.sql

# 4. í”„ë¡œë•ì…˜ ìŠ¤í‚¤ë§ˆ ë¤í”„ (ëŒ€ì‹œë³´ë“œì—ì„œ)
# Settings > Database > Schema ë‹¤ìš´ë¡œë“œ

# 5. ë¹„êµ
diff local_schema.sql production_schema.sql
```

### 3.2 í…Œì´ë¸”ë³„ ê²€ì¦ ì¿¼ë¦¬

```sql
-- ëª¨ë“  í…Œì´ë¸” ëª©ë¡
SELECT table_name
FROM information_schema.tables
WHERE table_schema = 'public'
ORDER BY table_name;

-- RLS ì •ì±… í™•ì¸
SELECT schemaname, tablename, policyname, cmd, qual
FROM pg_policies
WHERE schemaname = 'public'
ORDER BY tablename, policyname;

-- ì¸ë±ìŠ¤ í™•ì¸
SELECT tablename, indexname, indexdef
FROM pg_indexes
WHERE schemaname = 'public'
ORDER BY tablename;
```

---

## 4. ëˆ„ë½ ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒì„± ê°€ì´ë“œ

### 4.1 users í…Œì´ë¸” (í•„ìš”ì‹œ)

```sql
-- 202601090100_users_table.sql
-- Clerk ì‚¬ìš©ìì™€ ë™ê¸°í™”ë˜ëŠ” users í…Œì´ë¸”

CREATE TABLE IF NOT EXISTS users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  clerk_user_id TEXT NOT NULL UNIQUE,
  email TEXT,
  display_name TEXT,
  avatar_url TEXT,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- ì¸ë±ìŠ¤
CREATE INDEX IF NOT EXISTS idx_users_clerk_user_id ON users(clerk_user_id);

-- RLS
ALTER TABLE users ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can read own data" ON users
  FOR SELECT
  USING (clerk_user_id = auth.jwt() ->> 'sub');

CREATE POLICY "Users can update own data" ON users
  FOR UPDATE
  USING (clerk_user_id = auth.jwt() ->> 'sub');
```

### 4.2 ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ëª…ëª… ê·œì¹™

```
YYYYMMDDHHMM_<description>.sql

ì˜ˆì‹œ:
202601090100_users_table.sql
202601090200_missing_rls_policies.sql
202601090300_add_indexes.sql
```

---

## 5. RLS ì •ì±… í†µí•©

### 5.1 í‘œì¤€ íŒ¨í„´

```sql
-- ì½ê¸° (ë³¸ì¸ ë°ì´í„°ë§Œ)
CREATE POLICY "Users can read own data" ON <table_name>
  FOR SELECT
  USING (clerk_user_id = auth.jwt() ->> 'sub');

-- ì“°ê¸° (ë³¸ì¸ ë°ì´í„°ë§Œ)
CREATE POLICY "Users can insert own data" ON <table_name>
  FOR INSERT
  WITH CHECK (clerk_user_id = auth.jwt() ->> 'sub');

CREATE POLICY "Users can update own data" ON <table_name>
  FOR UPDATE
  USING (clerk_user_id = auth.jwt() ->> 'sub');

CREATE POLICY "Users can delete own data" ON <table_name>
  FOR DELETE
  USING (clerk_user_id = auth.jwt() ->> 'sub');
```

### 5.2 RLS ëˆ„ë½ í…Œì´ë¸” ì ê²€

```sql
-- RLS ë¯¸ì ìš© í…Œì´ë¸” ì°¾ê¸°
SELECT tablename
FROM pg_tables
WHERE schemaname = 'public'
  AND tablename NOT IN (
    SELECT DISTINCT tablename FROM pg_policies WHERE schemaname = 'public'
  );
```

---

## 6. ì›ì ë¶„í•´ (P3)

### ì˜ì¡´ì„± ê·¸ë˜í”„

```mermaid
graph TD
    A[ATOM-1: ìŠ¤í‚¤ë§ˆ ë¹„êµ ìŠ¤í¬ë¦½íŠ¸] --> B[ATOM-2: ëˆ„ë½ í…Œì´ë¸” ëª©ë¡ í™•ì •]
    B --> C[ATOM-3: ëˆ„ë½ ë§ˆì´ê·¸ë ˆì´ì…˜ SQL ì‘ì„±]
    B --> D[ATOM-4: RLS ì •ì±… í†µí•© SQL ì‘ì„±]
    C --> E[ATOM-5: ìŠ¤í…Œì´ì§• í™˜ê²½ ê²€ì¦]
    D --> E
    E --> F[ATOM-6: CI/CD íŒŒì´í”„ë¼ì¸ ì¶”ê°€]
    E --> G[ATOM-7: í”„ë¡œë•ì…˜ ì ìš©]
    F --> G
```

### ATOM-1: ìŠ¤í‚¤ë§ˆ ë¹„êµ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±

#### ë©”íƒ€ë°ì´í„°
- **ì˜ˆìƒ ì†Œìš”ì‹œê°„**: 1ì‹œê°„
- **ì˜ì¡´ì„±**: ì—†ìŒ
- **ë³‘ë ¬ ê°€ëŠ¥**: Yes

#### ì…ë ¥ ìŠ¤í™
| í•­ëª© | íƒ€ì… | í•„ìˆ˜ | ì„¤ëª… |
|------|------|------|------|
| Supabase CLI | tool | Yes | npx supabase |
| í”„ë¡œë•ì…˜ ì ‘ì† ì •ë³´ | env | Yes | SUPABASE_URL |

#### ì¶œë ¥ ìŠ¤í™
| í•­ëª© | íƒ€ì… | ì„¤ëª… |
|------|------|------|
| local_schema.sql | file | ë¡œì»¬ ìŠ¤í‚¤ë§ˆ ë¤í”„ |
| schema_diff.txt | file | ì°¨ì´ì  ëª©ë¡ |

#### ì„±ê³µ ê¸°ì¤€
- [ ] scripts/compare-schema.sh ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
- [ ] ë¡œì»¬ Supabase ì‹œì‘ ê°€ëŠ¥
- [ ] ìŠ¤í‚¤ë§ˆ ë¤í”„ ì„±ê³µ
- [ ] diff ê²°ê³¼ íŒŒì¼ ìƒì„±

#### íŒŒì¼ ë°°ì¹˜
| íŒŒì¼ ê²½ë¡œ | ë³€ê²½ ìœ í˜• | ì„¤ëª… |
|-----------|----------|------|
| `scripts/compare-schema.sh` | create | ìŠ¤í‚¤ë§ˆ ë¹„êµ ìŠ¤í¬ë¦½íŠ¸ |

---

### ATOM-2: ëˆ„ë½ í…Œì´ë¸” ëª©ë¡ í™•ì •

#### ë©”íƒ€ë°ì´í„°
- **ì˜ˆìƒ ì†Œìš”ì‹œê°„**: 1ì‹œê°„
- **ì˜ì¡´ì„±**: ATOM-1
- **ë³‘ë ¬ ê°€ëŠ¥**: No

#### ì…ë ¥ ìŠ¤í™
| í•­ëª© | íƒ€ì… | í•„ìˆ˜ | ì„¤ëª… |
|------|------|------|------|
| schema_diff.txt | file | Yes | ATOM-1 ì¶œë ¥ |
| supabase/migrations/ | dir | Yes | ê¸°ì¡´ ë§ˆì´ê·¸ë ˆì´ì…˜ |

#### ì¶œë ¥ ìŠ¤í™
| í•­ëª© | íƒ€ì… | ì„¤ëª… |
|------|------|------|
| MISSING_TABLES.md | file | ëˆ„ë½ í…Œì´ë¸” ìƒì„¸ ëª©ë¡ |

#### ì„±ê³µ ê¸°ì¤€
- [ ] ëˆ„ë½ í…Œì´ë¸” ëª©ë¡ í™•ì •
- [ ] ê° í…Œì´ë¸”ë³„ í•„ìš” ì»¬ëŸ¼ ì •ì˜
- [ ] ìš°ì„ ìˆœìœ„ ê²°ì •

#### íŒŒì¼ ë°°ì¹˜
| íŒŒì¼ ê²½ë¡œ | ë³€ê²½ ìœ í˜• | ì„¤ëª… |
|-----------|----------|------|
| `docs/MISSING_TABLES.md` | create | ëˆ„ë½ í…Œì´ë¸” ë¬¸ì„œ |

---

### ATOM-3: ëˆ„ë½ ë§ˆì´ê·¸ë ˆì´ì…˜ SQL ì‘ì„±

#### ë©”íƒ€ë°ì´í„°
- **ì˜ˆìƒ ì†Œìš”ì‹œê°„**: 2ì‹œê°„
- **ì˜ì¡´ì„±**: ATOM-2
- **ë³‘ë ¬ ê°€ëŠ¥**: Yes (ATOM-4ì™€ ë³‘ë ¬)

#### ì…ë ¥ ìŠ¤í™
| í•­ëª© | íƒ€ì… | í•„ìˆ˜ | ì„¤ëª… |
|------|------|------|------|
| MISSING_TABLES.md | file | Yes | ATOM-2 ì¶œë ¥ |

#### ì¶œë ¥ ìŠ¤í™
| í•­ëª© | íƒ€ì… | ì„¤ëª… |
|------|------|------|
| YYYYMMDDHHMM_*.sql | files | ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ë“¤ |

#### ì„±ê³µ ê¸°ì¤€
- [ ] ëª…ëª… ê·œì¹™ ì¤€ìˆ˜ (YYYYMMDDHHMM_description.sql)
- [ ] CREATE TABLE IF NOT EXISTS ì‚¬ìš©
- [ ] ì¸ë±ìŠ¤ í¬í•¨
- [ ] npx supabase db reset ì„±ê³µ
- [ ] typecheck í†µê³¼ (ìƒì„±ëœ types)

#### íŒŒì¼ ë°°ì¹˜
| íŒŒì¼ ê²½ë¡œ | ë³€ê²½ ìœ í˜• | ì„¤ëª… |
|-----------|----------|------|
| `apps/web/supabase/migrations/YYYYMMDDHHMM_*.sql` | create | ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ |

---

### ATOM-4: RLS ì •ì±… í†µí•© SQL ì‘ì„±

#### ë©”íƒ€ë°ì´í„°
- **ì˜ˆìƒ ì†Œìš”ì‹œê°„**: 1.5ì‹œê°„
- **ì˜ì¡´ì„±**: ATOM-2
- **ë³‘ë ¬ ê°€ëŠ¥**: Yes (ATOM-3ì™€ ë³‘ë ¬)

#### ì…ë ¥ ìŠ¤í™
| í•­ëª© | íƒ€ì… | í•„ìˆ˜ | ì„¤ëª… |
|------|------|------|------|
| MISSING_TABLES.md | file | Yes | ATOM-2 ì¶œë ¥ |
| í‘œì¤€ RLS íŒ¨í„´ | ref | Yes | ì„¹ì…˜ 5.1 ì°¸ì¡° |

#### ì¶œë ¥ ìŠ¤í™
| í•­ëª© | íƒ€ì… | ì„¤ëª… |
|------|------|------|
| YYYYMMDDHHMM_rls_policies.sql | file | RLS ì •ì±… ë§ˆì´ê·¸ë ˆì´ì…˜ |

#### ì„±ê³µ ê¸°ì¤€
- [ ] ëª¨ë“  í…Œì´ë¸”ì— RLS í™œì„±í™”
- [ ] SELECT/INSERT/UPDATE/DELETE ì •ì±… ì •ì˜
- [ ] clerk_user_id ê¸°ë°˜ ì •ì±…
- [ ] ëˆ„ë½ í…Œì´ë¸” ì—†ìŒ (ì¿¼ë¦¬ë¡œ í™•ì¸)

#### íŒŒì¼ ë°°ì¹˜
| íŒŒì¼ ê²½ë¡œ | ë³€ê²½ ìœ í˜• | ì„¤ëª… |
|-----------|----------|------|
| `apps/web/supabase/migrations/YYYYMMDDHHMM_rls_policies.sql` | create | RLS ë§ˆì´ê·¸ë ˆì´ì…˜ |

---

### ATOM-5: ìŠ¤í…Œì´ì§• í™˜ê²½ ê²€ì¦

#### ë©”íƒ€ë°ì´í„°
- **ì˜ˆìƒ ì†Œìš”ì‹œê°„**: 1.5ì‹œê°„
- **ì˜ì¡´ì„±**: ATOM-3, ATOM-4
- **ë³‘ë ¬ ê°€ëŠ¥**: No

#### ì…ë ¥ ìŠ¤í™
| í•­ëª© | íƒ€ì… | í•„ìˆ˜ | ì„¤ëª… |
|------|------|------|------|
| ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ë“¤ | files | Yes | ATOM-3, ATOM-4 ì¶œë ¥ |
| STAGING_DB_URL | env | Yes | ìŠ¤í…Œì´ì§• ì ‘ì† ì •ë³´ |

#### ì¶œë ¥ ìŠ¤í™
| í•­ëª© | íƒ€ì… | ì„¤ëª… |
|------|------|------|
| í…ŒìŠ¤íŠ¸ ê²°ê³¼ | report | ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ ê²°ê³¼ |

#### ì„±ê³µ ê¸°ì¤€
- [ ] npx supabase db push --db-url $STAGING_DB_URL ì„±ê³µ
- [ ] íšŒì›ê°€ì…/ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸ í†µê³¼
- [ ] PC-1, S-1, C-1 ë¶„ì„ í…ŒìŠ¤íŠ¸ í†µê³¼
- [ ] ë°ì´í„° ì €ì¥/ì¡°íšŒ í…ŒìŠ¤íŠ¸ í†µê³¼

#### íŒŒì¼ ë°°ì¹˜
| íŒŒì¼ ê²½ë¡œ | ë³€ê²½ ìœ í˜• | ì„¤ëª… |
|-----------|----------|------|
| - | - | íŒŒì¼ ë³€ê²½ ì—†ìŒ (ê²€ì¦ë§Œ) |

---

### ATOM-6: CI/CD íŒŒì´í”„ë¼ì¸ ì¶”ê°€

#### ë©”íƒ€ë°ì´í„°
- **ì˜ˆìƒ ì†Œìš”ì‹œê°„**: 1ì‹œê°„
- **ì˜ì¡´ì„±**: ATOM-5
- **ë³‘ë ¬ ê°€ëŠ¥**: Yes (ATOM-7ê³¼ ë³‘ë ¬ ì¤€ë¹„)

#### ì…ë ¥ ìŠ¤í™
| í•­ëª© | íƒ€ì… | í•„ìˆ˜ | ì„¤ëª… |
|------|------|------|------|
| ì„¹ì…˜ 8.1 í…œí”Œë¦¿ | yaml | Yes | db-validate.yml ì°¸ì¡° |

#### ì¶œë ¥ ìŠ¤í™
| í•­ëª© | íƒ€ì… | ì„¤ëª… |
|------|------|------|
| db-validate.yml | file | GitHub Actions ì›Œí¬í”Œë¡œìš° |

#### ì„±ê³µ ê¸°ì¤€
- [ ] PR ì‹œ ìë™ ìŠ¤í‚¤ë§ˆ ê²€ì¦
- [ ] npx supabase db lint í†µê³¼
- [ ] íƒ€ì… ìƒì„± ìë™í™”

#### íŒŒì¼ ë°°ì¹˜
| íŒŒì¼ ê²½ë¡œ | ë³€ê²½ ìœ í˜• | ì„¤ëª… |
|-----------|----------|------|
| `.github/workflows/db-validate.yml` | create | CI/CD ì›Œí¬í”Œë¡œìš° |

---

### ATOM-7: í”„ë¡œë•ì…˜ ì ìš©

#### ë©”íƒ€ë°ì´í„°
- **ì˜ˆìƒ ì†Œìš”ì‹œê°„**: 1ì‹œê°„
- **ì˜ì¡´ì„±**: ATOM-5, ATOM-6
- **ë³‘ë ¬ ê°€ëŠ¥**: No

#### ì…ë ¥ ìŠ¤í™
| í•­ëª© | íƒ€ì… | í•„ìˆ˜ | ì„¤ëª… |
|------|------|------|------|
| ê²€ì¦ëœ ë§ˆì´ê·¸ë ˆì´ì…˜ | files | Yes | ATOM-5 í†µê³¼ |
| PRODUCTION_DB_URL | env | Yes | í”„ë¡œë•ì…˜ ì ‘ì† ì •ë³´ |

#### ì¶œë ¥ ìŠ¤í™
| í•­ëª© | íƒ€ì… | ì„¤ëª… |
|------|------|------|
| ì ìš© ë¡œê·¸ | log | ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš© ê²°ê³¼ |

#### ì„±ê³µ ê¸°ì¤€
- [ ] í”„ë¡œë•ì…˜ ë§ˆì´ê·¸ë ˆì´ì…˜ ì„±ê³µ
- [ ] ë¡¤ë°± ìŠ¤í¬ë¦½íŠ¸ ì¤€ë¹„
- [ ] ëª¨ë‹ˆí„°ë§ ì•Œë¦¼ ì—†ìŒ (30ë¶„)

#### íŒŒì¼ ë°°ì¹˜
| íŒŒì¼ ê²½ë¡œ | ë³€ê²½ ìœ í˜• | ì„¤ëª… |
|-----------|----------|------|
| - | - | íŒŒì¼ ë³€ê²½ ì—†ìŒ (ì ìš©ë§Œ) |

---

### ì´ ì†Œìš”ì‹œê°„ ìš”ì•½

| ì›ì | ì†Œìš”ì‹œê°„ | ë³‘ë ¬ ê°€ëŠ¥ | ìƒíƒœ |
|------|----------|----------|------|
| ATOM-1 | 1ì‹œê°„ | Yes | â³ |
| ATOM-2 | 1ì‹œê°„ | No | â³ |
| ATOM-3 | 2ì‹œê°„ | Yes | â³ |
| ATOM-4 | 1.5ì‹œê°„ | Yes (with ATOM-3) | â³ |
| ATOM-5 | 1.5ì‹œê°„ | No | â³ |
| ATOM-6 | 1ì‹œê°„ | Yes | â³ |
| ATOM-7 | 1ì‹œê°„ | No | â³ |
| **ì´í•©** | **9ì‹œê°„** | ë³‘ë ¬ ì‹œ **7ì‹œê°„** | - |

---

## 7. êµ¬í˜„ ì²´í¬ë¦¬ìŠ¤íŠ¸ (ë ˆê±°ì‹œ)

| ìˆœì„œ | ì‘ì—…                         | ë‹´ë‹¹   | ì›ì  | ìƒíƒœ |
| ---- | ---------------------------- | ------ | ----- | ---- |
| 1    | ë¡œì»¬ vs í”„ë¡œë•ì…˜ ìŠ¤í‚¤ë§ˆ ë¹„êµ | ê°œë°œì | ATOM-1 | â³   |
| 2    | ëˆ„ë½ í…Œì´ë¸” ëª©ë¡ í™•ì •        | ê°œë°œì | ATOM-2 | â³   |
| 3    | ëˆ„ë½ ë§ˆì´ê·¸ë ˆì´ì…˜ SQL ì‘ì„±   | ê°œë°œì | ATOM-3 | â³   |
| 4    | ìŠ¤í…Œì´ì§• í™˜ê²½ ê²€ì¦           | ê°œë°œì | ATOM-5 | â³   |
| 5    | í”„ë¡œë•ì…˜ ì ìš©                | ìš´ì˜   | ATOM-7 | â³   |

---

## 8. ë°°í¬ ì „ ê²€ì¦

### 8.1 ìŠ¤í…Œì´ì§• í™˜ê²½ í…ŒìŠ¤íŠ¸

```bash
# 1. ìƒˆ Supabase í”„ë¡œì íŠ¸ ìƒì„± (ìŠ¤í…Œì´ì§•)
# 2. ëª¨ë“  ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš©
npx supabase db push --db-url $STAGING_DB_URL

# 3. ì•± ì—°ê²° í…ŒìŠ¤íŠ¸
NEXT_PUBLIC_SUPABASE_URL=$STAGING_URL npm run dev

# 4. ì£¼ìš” ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
# - íšŒì›ê°€ì…/ë¡œê·¸ì¸
# - ë¶„ì„ (PC-1, S-1, C-1)
# - ë°ì´í„° ì €ì¥/ì¡°íšŒ
```

### 8.2 ë¡¤ë°± ê³„íš

```sql
-- ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨ ì‹œ ë¡¤ë°± SQL ì¤€ë¹„
-- ê° ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ì— ëŒ€ì‘í•˜ëŠ” down.sql ì‘ì„±

-- ì˜ˆ: 202601090100_users_table_down.sql
DROP POLICY IF EXISTS "Users can read own data" ON users;
DROP POLICY IF EXISTS "Users can update own data" ON users;
DROP TABLE IF EXISTS users;
```

---

## 9. ìë™í™” ê¶Œì¥ì‚¬í•­

### 9.1 CI/CD í†µí•©

```yaml
# .github/workflows/db-validate.yml
name: Validate DB Schema

on:
  pull_request:
    paths:
      - 'apps/web/supabase/migrations/**'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
      - name: Start Supabase
        run: npx supabase start
      - name: Apply Migrations
        run: npx supabase db reset
      - name: Verify Schema
        run: npx supabase db lint
```

### 9.2 ìŠ¤í‚¤ë§ˆ ë¬¸ì„œ ìë™ ìƒì„±

```bash
# ìŠ¤í‚¤ë§ˆ ë¬¸ì„œ ìƒì„± ìŠ¤í¬ë¦½íŠ¸
npx supabase gen types typescript --local > types/database.types.ts
```

---

## 10. ì°¸ê³  ë¬¸ì„œ

| ë¬¸ì„œ                                                      | ì„¤ëª…             |
| --------------------------------------------------------- | ---------------- |
| [DATABASE-SCHEMA.md](../DATABASE-SCHEMA.md)               | ì „ì²´ ìŠ¤í‚¤ë§ˆ ë¬¸ì„œ |
| [DB-FUNCTIONS-GUIDE.md](../DB-FUNCTIONS-GUIDE.md)         | DB í•¨ìˆ˜ ê°€ì´ë“œ   |
| [Supabase CLI ë¬¸ì„œ](https://supabase.com/docs/guides/cli) | ê³µì‹ CLI ë¬¸ì„œ    |

---

## 11. ë³€ê²½ ì´ë ¥

| ë²„ì „ | ë‚ ì§œ       | ë³€ê²½ ë‚´ìš© |
| ---- | ---------- | --------- |
| 1.0  | 2026-01-08 | ìµœì´ˆ ì‘ì„± |
| 2.0  | 2026-01-19 | P3 ì›ì ë¶„í•´ ì¶”ê°€ (7 ATOMs) |

---

**Version**: 2.0
**Created**: 2026-01-08
**Updated**: 2026-01-19
