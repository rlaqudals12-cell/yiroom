/**
 * ìŒì‹ JSON ë°ì´í„°ì—ì„œ Supabase seed SQL ìƒì„±
 * Task 1.4: ê¸°ë³¸ ìŒì‹ DB ì‹œë”© (500ì¢…)
 *
 * ì‚¬ìš©ë²•: npx tsx scripts/generate-food-seed.ts
 */

import * as fs from 'fs';
import * as path from 'path';

interface FoodData {
  id: string;
  name: string;
  nameEn: string;
  category: string;
  servingSize: string;
  servingGrams: number;
  calories: number;
  protein: number;
  carbs: number;
  fat: number;
  fiber: number;
  sugar: number;
  sodium: number;
  trafficLight: string;
  isKorean: boolean;
  tags: string[];
}

// ì¹´í…Œê³ ë¦¬ íŒŒì¼ ëª©ë¡ê³¼ í•œê¸€ëª…
const categories = [
  { file: 'rice.json', name: 'ë°¥ë¥˜ (Rice)', count: 50 },
  { file: 'soup.json', name: 'êµ­/ì°Œê°œ (Soup)', count: 50 },
  { file: 'side.json', name: 'ë°˜ì°¬ (Side Dishes)', count: 80 },
  { file: 'meat.json', name: 'ê³ ê¸° (Meat)', count: 50 },
  { file: 'seafood.json', name: 'í•´ì‚°ë¬¼ (Seafood)', count: 40 },
  { file: 'noodle.json', name: 'ë©´ë¥˜ (Noodle)', count: 40 },
  { file: 'bread.json', name: 'ë¹µ/ë””ì €íŠ¸ (Bread/Dessert)', count: 50 },
  { file: 'beverage.json', name: 'ìŒë£Œ (Beverage)', count: 40 },
  { file: 'fruit.json', name: 'ê³¼ì¼ (Fruit)', count: 50 },
  { file: 'fastfood.json', name: 'íŒ¨ìŠ¤íŠ¸í‘¸ë“œ (Fast Food)', count: 50 },
];

// SQL ë¬¸ìì—´ ì´ìŠ¤ì¼€ì´í”„
function escapeSQL(str: string): string {
  return str.replace(/'/g, "''");
}

// ë‹¨ì¼ ìŒì‹ INSERT VALUE ìƒì„±
function foodToSQLValue(food: FoodData): string {
  const tags = food.tags.map((t) => `'${escapeSQL(t)}'`).join(', ');
  return `  ('${escapeSQL(food.name)}', '${escapeSQL(food.nameEn)}', '${food.category}', '${escapeSQL(food.servingSize)}', ${food.servingGrams}, ${food.calories}, ${food.protein}, ${food.carbs}, ${food.fat}, ${food.fiber}, ${food.sugar}, ${food.sodium}, '${food.trafficLight}', ${food.isKorean}, ARRAY[${tags}])`;
}

// ì¹´í…Œê³ ë¦¬ë³„ INSERT ë¬¸ ìƒì„±
function generateCategorySQL(
  categoryName: string,
  expectedCount: number,
  foods: FoodData[]
): string {
  const lines: string[] = [];
  lines.push(`-- =====================================================`);
  lines.push(`-- ${categoryName} - ${foods.length}ì¢…`);
  lines.push(`-- =====================================================`);
  lines.push(
    `INSERT INTO foods (name, name_en, category, serving_size, serving_grams, calories, protein, carbs, fat, fiber, sugar, sodium, traffic_light, is_korean, tags)`
  );
  lines.push(`VALUES`);

  const values = foods.map((food, i) => {
    const value = foodToSQLValue(food);
    return i < foods.length - 1 ? value + ',' : value + ';';
  });

  lines.push(...values);
  lines.push('');

  return lines.join('\n');
}

// ë©”ì¸ ì‹¤í–‰
async function main() {
  const dataDir = path.join(process.cwd(), 'data', 'foods');
  const outputPath = path.join(process.cwd(), 'supabase', 'seed-foods.sql');

  // SQL í—¤ë”
  const header = `-- Seed Script: foods í…Œì´ë¸” ì‹œë”©
-- Task 1.4: ê¸°ë³¸ ìŒì‹ DB ì‹œë”© (500ì¢…)
-- Date: 2025-12-01
-- Auto-generated by scripts/generate-food-seed.ts
--
-- ì‚¬ìš©ë²•:
-- 1. Supabase Dashboard > SQL Editor ì—ì„œ ì‹¤í–‰
-- 2. ë˜ëŠ” npx supabase db reset (ë¡œì»¬ ê°œë°œ ì‹œ)
--
-- ì°¸ê³ : ì´ íŒŒì¼ì€ data/foods/*.json íŒŒì¼ì˜ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìƒì„±ë¨

-- ê¸°ì¡´ ë°ì´í„° ì‚­ì œ (í•„ìš”ì‹œ)
-- TRUNCATE TABLE foods RESTART IDENTITY;

`;

  let totalCount = 0;
  const sqlParts: string[] = [header];

  // ê° ì¹´í…Œê³ ë¦¬ ì²˜ë¦¬
  for (const category of categories) {
    const filePath = path.join(dataDir, category.file);

    if (!fs.existsSync(filePath)) {
      console.error(`íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${filePath}`);
      continue;
    }

    const content = fs.readFileSync(filePath, 'utf-8');
    const foods: FoodData[] = JSON.parse(content);

    console.log(`${category.name}: ${foods.length}ê°œ (ì˜ˆìƒ: ${category.count})`);
    totalCount += foods.length;

    const sql = generateCategorySQL(category.name, category.count, foods);
    sqlParts.push(sql);
  }

  // í‘¸í„°
  const footer = `-- =====================================================
-- ì´ ${totalCount}ì¢… ìŒì‹ ë°ì´í„° ì‹œë”© ì™„ë£Œ
-- =====================================================
`;
  sqlParts.push(footer);

  // íŒŒì¼ ì“°ê¸°
  fs.writeFileSync(outputPath, sqlParts.join('\n'), 'utf-8');
  console.log(`\nâœ… SQL íŒŒì¼ ìƒì„± ì™„ë£Œ: ${outputPath}`);
  console.log(`ğŸ“Š ì´ ìŒì‹ ìˆ˜: ${totalCount}ì¢…`);
}

main().catch(console.error);
